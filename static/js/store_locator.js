function InfoBox(opt_opts){opt_opts=opt_opts||{},google.maps.OverlayView.apply(this,arguments),this.content_=opt_opts.content||"",this.disableAutoPan_=opt_opts.disableAutoPan||!1,this.maxWidth_=opt_opts.maxWidth||0,this.pixelOffset_=opt_opts.pixelOffset||new google.maps.Size(0,0),this.position_=opt_opts.position||new google.maps.LatLng(0,0),this.zIndex_=opt_opts.zIndex||null,this.boxClass_=opt_opts.boxClass||"infoBox",this.boxStyle_=opt_opts.boxStyle||{},this.closeBoxMargin_=opt_opts.closeBoxMargin||"2px",this.closeBoxURL_=opt_opts.closeBoxURL||"http://www.google.com/intl/en_us/mapfiles/close.gif",""===opt_opts.closeBoxURL&&(this.closeBoxURL_=""),this.infoBoxClearance_=opt_opts.infoBoxClearance||new google.maps.Size(1,1),"undefined"==typeof opt_opts.visible&&("undefined"==typeof opt_opts.isHidden?opt_opts.visible=!0:opt_opts.visible=!opt_opts.isHidden),this.isHidden_=!opt_opts.visible,this.alignBottom_=opt_opts.alignBottom||!1,this.pane_=opt_opts.pane||"floatPane",this.enableEventPropagation_=opt_opts.enableEventPropagation||!1,this.div_=null,this.closeListener_=null,this.moveListener_=null,this.contextListener_=null,this.eventListeners_=null,this.fixedWidthSet_=null}!function($){var converter={vertical:{x:!1,y:!0},horizontal:{x:!0,y:!1},both:{x:!0,y:!0},x:{x:!0,y:!1},y:{x:!1,y:!0}},settings={duration:"fast",direction:"both"},rootrx=/^(?:html)$/i,borders=function(domElement,styles){styles=styles||(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(domElement,null):domElement.currentStyle);var px=!(!document.defaultView||!document.defaultView.getComputedStyle),b={top:parseFloat(px?styles.borderTopWidth:$.css(domElement,"borderTopWidth"))||0,left:parseFloat(px?styles.borderLeftWidth:$.css(domElement,"borderLeftWidth"))||0,bottom:parseFloat(px?styles.borderBottomWidth:$.css(domElement,"borderBottomWidth"))||0,right:parseFloat(px?styles.borderRightWidth:$.css(domElement,"borderRightWidth"))||0};return{top:b.top,left:b.left,bottom:b.bottom,right:b.right,vertical:b.top+b.bottom,horizontal:b.left+b.right}},dimensions=function($element){var win=$(window),isRoot=rootrx.test($element[0].nodeName);return{border:isRoot?{top:0,left:0,bottom:0,right:0}:borders($element[0]),scroll:{top:(isRoot?win:$element).scrollTop(),left:(isRoot?win:$element).scrollLeft()},scrollbar:{right:isRoot?0:$element.innerWidth()-$element[0].clientWidth,bottom:isRoot?0:$element.innerHeight()-$element[0].clientHeight},rect:function(){var r=$element[0].getBoundingClientRect();return{top:isRoot?0:r.top,left:isRoot?0:r.left,bottom:isRoot?$element[0].clientHeight:r.bottom,right:isRoot?$element[0].clientWidth:r.right}}()}};$.fn.extend({scrollintoview:function(options){options=$.extend({},settings,options),options.direction=converter["string"==typeof options.direction&&options.direction.toLowerCase()]||converter.both;var dirStr="";options.direction.x===!0&&(dirStr="horizontal"),options.direction.y===!0&&(dirStr=dirStr?"both":"vertical");var el=this.eq(0),scroller=el.closest(":scrollable("+dirStr+")");if(scroller.length>0){scroller=scroller.eq(0);var dim={e:dimensions(el),s:dimensions(scroller)},rel={top:dim.e.rect.top-(dim.s.rect.top+dim.s.border.top),bottom:dim.s.rect.bottom-dim.s.border.bottom-dim.s.scrollbar.bottom-dim.e.rect.bottom,left:dim.e.rect.left-(dim.s.rect.left+dim.s.border.left),right:dim.s.rect.right-dim.s.border.right-dim.s.scrollbar.right-dim.e.rect.right},animOptions={};options.direction.y===!0&&(rel.top<0?animOptions.scrollTop=dim.s.scroll.top+rel.top:rel.top>0&&rel.bottom<0&&(animOptions.scrollTop=dim.s.scroll.top+Math.min(rel.top,-rel.bottom))),options.direction.x===!0&&(rel.left<0?animOptions.scrollLeft=dim.s.scroll.left+rel.left:rel.left>0&&rel.right<0&&(animOptions.scrollLeft=dim.s.scroll.left+Math.min(rel.left,-rel.right))),$.isEmptyObject(animOptions)?$.isFunction(options.complete)&&options.complete.call(scroller[0]):(rootrx.test(scroller[0].nodeName)&&(scroller=$("html,body")),scroller.animate(animOptions,options.duration).eq(0).queue(function(next){$.isFunction(options.complete)&&options.complete.call(scroller[0]),next()}))}return this}});var scrollValue={auto:!0,scroll:!0,visible:!1,hidden:!1};$.extend($.expr[":"],{scrollable:function(element,index,meta,stack){var direction=converter["string"==typeof meta[3]&&meta[3].toLowerCase()]||converter.both,styles=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(element,null):element.currentStyle,overflow={x:scrollValue[styles.overflowX.toLowerCase()]||!1,y:scrollValue[styles.overflowY.toLowerCase()]||!1,isRoot:rootrx.test(element.nodeName)};if(!overflow.x&&!overflow.y&&!overflow.isRoot)return!1;var size={height:{scroll:element.scrollHeight,client:element.clientHeight},width:{scroll:element.scrollWidth,client:element.clientWidth},scrollableX:function(){return(overflow.x||overflow.isRoot)&&this.width.scroll>this.width.client},scrollableY:function(){return(overflow.y||overflow.isRoot)&&this.height.scroll>this.height.client}};return direction.y&&size.scrollableY()||direction.x&&size.scrollableX()}})}(jQuery),jQuery.cookie=function(key,value,options){if(arguments.length>1&&"[object Object]"!==String(value)){if(options=jQuery.extend({},options),null!==value&&void 0!==value||(options.expires=-1),"number"==typeof options.expires){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}return value=String(value),document.cookie=[encodeURIComponent(key),"=",options.raw?value:encodeURIComponent(value),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}options=value||{};var result,decode=options.raw?function(s){return s}:decodeURIComponent;return(result=new RegExp("(?:^|; )"+encodeURIComponent(key)+"=([^;]*)").exec(document.cookie))?decode(result[1]):null},function(window,undefined){var Globalize,regexHex,regexInfinity,regexParseFloat,regexTrim,arrayIndexOf,endsWith,extend,isArray,isFunction,isObject,startsWith,trim,truncate,zeroPad,appendPreOrPostMatch,expandFormat,formatDate,formatNumber,getTokenRegExp,getEra,getEraYear,parseExact,parseNegativePattern;Globalize=function(cultureSelector){return new Globalize.prototype.init(cultureSelector)},"undefined"!=typeof require&&"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=Globalize:window.Globalize=Globalize,Globalize.cultures={},Globalize.prototype={constructor:Globalize,init:function(cultureSelector){return this.cultures=Globalize.cultures,this.cultureSelector=cultureSelector,this}},Globalize.prototype.init.prototype=Globalize.prototype,Globalize.cultures["default"]={name:"en",englishName:"English",nativeName:"English",isRTL:!1,language:"en",numberFormat:{pattern:["-n"],decimals:2,",":",",".":".",groupSizes:[3],"+":"+","-":"-",NaN:"NaN",negativeInfinity:"-Infinity",positiveInfinity:"Infinity",percent:{pattern:["-n %","n %"],decimals:2,groupSizes:[3],",":",",".":".",symbol:"%"},currency:{pattern:["($n)","$n"],decimals:2,groupSizes:[3],",":",",".":".",symbol:"$"}},calendars:{standard:{name:"Gregorian_USEnglish","/":"/",":":":",firstDay:0,days:{names:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],namesAbbr:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],namesShort:["Su","Mo","Tu","We","Th","Fr","Sa"]},months:{names:["January","February","March","April","May","June","July","August","September","October","November","December",""],namesAbbr:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec",""]},AM:["AM","am","AM"],PM:["PM","pm","PM"],eras:[{name:"A.D.",start:null,offset:0}],twoDigitYearMax:2029,patterns:{d:"M/d/yyyy",D:"dddd, MMMM dd, yyyy",t:"h:mm tt",T:"h:mm:ss tt",f:"dddd, MMMM dd, yyyy h:mm tt",F:"dddd, MMMM dd, yyyy h:mm:ss tt",M:"MMMM dd",Y:"yyyy MMMM",S:"yyyy'-'MM'-'dd'T'HH':'mm':'ss"}}},messages:{}},Globalize.cultures["default"].calendar=Globalize.cultures["default"].calendars.standard,Globalize.cultures.en=Globalize.cultures["default"],Globalize.cultureSelector="en",regexHex=/^0x[a-f0-9]+$/i,regexInfinity=/^[+-]?infinity$/i,regexParseFloat=/^[+-]?\d*\.?\d*(e[+-]?\d+)?$/,regexTrim=/^\s+|\s+$/g,arrayIndexOf=function(array,item){if(array.indexOf)return array.indexOf(item);for(var i=0,length=array.length;i<length;i++)if(array[i]===item)return i;return-1},endsWith=function(value,pattern){return value.substr(value.length-pattern.length)===pattern},extend=function(deep){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=!1;for("boolean"==typeof target&&(deep=target,target=arguments[1]||{},i=2),"object"==typeof target||isFunction(target)||(target={});i<length;i++)if(null!=(options=arguments[i]))for(name in options)src=target[name],copy=options[name],target!==copy&&(deep&&copy&&(isObject(copy)||(copyIsArray=isArray(copy)))?(copyIsArray?(copyIsArray=!1,clone=src&&isArray(src)?src:[]):clone=src&&isObject(src)?src:{},target[name]=extend(deep,clone,copy)):copy!==undefined&&(target[name]=copy));return target},isArray=Array.isArray||function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},isFunction=function(obj){return"[object Function]"===Object.prototype.toString.call(obj)},isObject=function(obj){return"[object Object]"===Object.prototype.toString.call(obj)},startsWith=function(value,pattern){return 0===value.indexOf(pattern)},trim=function(value){return(value+"").replace(regexTrim,"")},truncate=function(value){return isNaN(value)?NaN:Math[value<0?"ceil":"floor"](value)},zeroPad=function(str,count,left){var l;for(l=str.length;l<count;l+=1)str=left?"0"+str:str+"0";return str},appendPreOrPostMatch=function(preMatch,strings){for(var quoteCount=0,escaped=!1,i=0,il=preMatch.length;i<il;i++){var c=preMatch.charAt(i);switch(c){case"'":escaped?strings.push("'"):quoteCount++,escaped=!1;break;case"\\":escaped&&strings.push("\\"),escaped=!escaped;break;default:strings.push(c),escaped=!1}}return quoteCount},expandFormat=function(cal,format){format=format||"F";var pattern,patterns=cal.patterns,len=format.length;if(1===len){if(pattern=patterns[format],!pattern)throw"Invalid date format string '"+format+"'.";format=pattern}else 2===len&&"%"===format.charAt(0)&&(format=format.charAt(1));return format},formatDate=function(value,format,culture){function padZeros(num,c){var r,s=num+"";return c>1&&s.length<c?(r=zeros[c-2]+s,r.substr(r.length-c,c)):r=s}function hasDay(){return foundDay||checkedDay?foundDay:(foundDay=dayPartRegExp.test(format),checkedDay=!0,foundDay)}function getPart(date,part){if(converted)return converted[part];switch(part){case 0:return date.getFullYear();case 1:return date.getMonth();case 2:return date.getDate()}}var cal=culture.calendar,convert=cal.convert;if(!format||!format.length||"i"===format){var ret;if(culture&&culture.name.length)if(convert)ret=formatDate(value,cal.patterns.F,culture);else{var eraDate=new Date(value.getTime()),era=getEra(value,cal.eras);eraDate.setFullYear(getEraYear(value,cal,era)),ret=eraDate.toLocaleString()}else ret=value.toString();return ret}var eras=cal.eras,sortable="s"===format;format=expandFormat(cal,format),ret=[];var hour,foundDay,checkedDay,converted,zeros=["0","00","000"],dayPartRegExp=/([^d]|^)(d|dd)([^d]|$)/g,quoteCount=0,tokenRegExp=getTokenRegExp();for(!sortable&&convert&&(converted=convert.fromGregorian(value));;){var index=tokenRegExp.lastIndex,ar=tokenRegExp.exec(format),preMatch=format.slice(index,ar?ar.index:format.length);if(quoteCount+=appendPreOrPostMatch(preMatch,ret),!ar)break;if(quoteCount%2)ret.push(ar[0]);else{var current=ar[0],clength=current.length;switch(current){case"ddd":case"dddd":var names=3===clength?cal.days.namesAbbr:cal.days.names;ret.push(names[value.getDay()]);break;case"d":case"dd":foundDay=!0,ret.push(padZeros(getPart(value,2),clength));break;case"MMM":case"MMMM":var part=getPart(value,1);ret.push(cal.monthsGenitive&&hasDay()?cal.monthsGenitive[3===clength?"namesAbbr":"names"][part]:cal.months[3===clength?"namesAbbr":"names"][part]);break;case"M":case"MM":ret.push(padZeros(getPart(value,1)+1,clength));break;case"y":case"yy":case"yyyy":part=converted?converted[0]:getEraYear(value,cal,getEra(value,eras),sortable),clength<4&&(part%=100),ret.push(padZeros(part,clength));break;case"h":case"hh":hour=value.getHours()%12,0===hour&&(hour=12),ret.push(padZeros(hour,clength));break;case"H":case"HH":ret.push(padZeros(value.getHours(),clength));break;case"m":case"mm":ret.push(padZeros(value.getMinutes(),clength));break;case"s":case"ss":ret.push(padZeros(value.getSeconds(),clength));break;case"t":case"tt":part=value.getHours()<12?cal.AM?cal.AM[0]:" ":cal.PM?cal.PM[0]:" ",ret.push(1===clength?part.charAt(0):part);break;case"f":case"ff":case"fff":ret.push(padZeros(value.getMilliseconds(),3).substr(0,clength));break;case"z":case"zz":hour=value.getTimezoneOffset()/60,ret.push((hour<=0?"+":"-")+padZeros(Math.floor(Math.abs(hour)),clength));break;case"zzz":hour=value.getTimezoneOffset()/60,ret.push((hour<=0?"+":"-")+padZeros(Math.floor(Math.abs(hour)),2)+":"+padZeros(Math.abs(value.getTimezoneOffset()%60),2));break;case"g":case"gg":cal.eras&&ret.push(cal.eras[getEra(value,eras)].name);break;case"/":ret.push(cal["/"]);break;default:throw"Invalid date format pattern '"+current+"'."}}}return ret.join("")},function(){var expandNumber;expandNumber=function(number,precision,formatInfo){var groupSizes=formatInfo.groupSizes,curSize=groupSizes[0],curGroupIndex=1,factor=Math.pow(10,precision),rounded=Math.round(number*factor)/factor;isFinite(rounded)||(rounded=number),number=rounded;var numberString=number+"",right="",split=numberString.split(/e/i),exponent=split.length>1?parseInt(split[1],10):0;numberString=split[0],split=numberString.split("."),numberString=split[0],right=split.length>1?split[1]:"";exponent>0?(right=zeroPad(right,exponent,!1),numberString+=right.slice(0,exponent),right=right.substr(exponent)):exponent<0&&(exponent=-exponent,numberString=zeroPad(numberString,exponent+1),right=numberString.slice(-exponent,numberString.length)+right,numberString=numberString.slice(0,-exponent)),right=precision>0?formatInfo["."]+(right.length>precision?right.slice(0,precision):zeroPad(right,precision)):"";for(var stringIndex=numberString.length-1,sep=formatInfo[","],ret="";stringIndex>=0;){if(0===curSize||curSize>stringIndex)return numberString.slice(0,stringIndex+1)+(ret.length?sep+ret+right:right);ret=numberString.slice(stringIndex-curSize+1,stringIndex+1)+(ret.length?sep+ret:""),stringIndex-=curSize,curGroupIndex<groupSizes.length&&(curSize=groupSizes[curGroupIndex],curGroupIndex++)}return numberString.slice(0,stringIndex+1)+sep+ret+right},formatNumber=function(value,format,culture){if(!isFinite(value))return value===1/0?culture.numberFormat.positiveInfinity:value===-(1/0)?culture.numberFormat.negativeInfinity:culture.numberFormat.NaN;if(!format||"i"===format)return culture.name.length?value.toLocaleString():value.toString();format=format||"D";var pattern,nf=culture.numberFormat,number=Math.abs(value),precision=-1;format.length>1&&(precision=parseInt(format.slice(1),10));var formatInfo,current=format.charAt(0).toUpperCase();switch(current){case"D":pattern="n",number=truncate(number),precision!==-1&&(number=zeroPad(""+number,precision,!0)),value<0&&(number="-"+number);break;case"N":formatInfo=nf;case"C":formatInfo=formatInfo||nf.currency;case"P":formatInfo=formatInfo||nf.percent,pattern=value<0?formatInfo.pattern[0]:formatInfo.pattern[1]||"n",precision===-1&&(precision=formatInfo.decimals),number=expandNumber(number*("P"===current?100:1),precision,formatInfo);break;default:throw"Bad number format specifier: "+current}for(var patternParts=/n|\$|-|%/g,ret="";;){var index=patternParts.lastIndex,ar=patternParts.exec(pattern);if(ret+=pattern.slice(index,ar?ar.index:pattern.length),!ar)break;switch(ar[0]){case"n":ret+=number;break;case"$":ret+=nf.currency.symbol;break;case"-":/[1-9]/.test(number)&&(ret+=nf["-"]);break;case"%":ret+=nf.percent.symbol}}return ret}}(),getTokenRegExp=function(){return/\/|dddd|ddd|dd|d|MMMM|MMM|MM|M|yyyy|yy|y|hh|h|HH|H|mm|m|ss|s|tt|t|fff|ff|f|zzz|zz|z|gg|g/g},getEra=function(date,eras){if(!eras)return 0;for(var start,ticks=date.getTime(),i=0,l=eras.length;i<l;i++)if(start=eras[i].start,null===start||ticks>=start)return i;return 0},getEraYear=function(date,cal,era,sortable){var year=date.getFullYear();return!sortable&&cal.eras&&(year-=cal.eras[era].offset),year},function(){var expandYear,getDayIndex,getMonthIndex,getParseRegExp,outOfRange,toUpper,toUpperArray;expandYear=function(cal,year){if(year<100){var now=new Date,era=getEra(now),curr=getEraYear(now,cal,era),twoDigitYearMax=cal.twoDigitYearMax;twoDigitYearMax="string"==typeof twoDigitYearMax?(new Date).getFullYear()%100+parseInt(twoDigitYearMax,10):twoDigitYearMax,year+=curr-curr%100,year>twoDigitYearMax&&(year-=100)}return year},getDayIndex=function(cal,value,abbr){var ret,days=cal.days,upperDays=cal._upperDays;return upperDays||(cal._upperDays=upperDays=[toUpperArray(days.names),toUpperArray(days.namesAbbr),toUpperArray(days.namesShort)]),value=toUpper(value),abbr?(ret=arrayIndexOf(upperDays[1],value),ret===-1&&(ret=arrayIndexOf(upperDays[2],value))):ret=arrayIndexOf(upperDays[0],value),ret},getMonthIndex=function(cal,value,abbr){var months=cal.months,monthsGen=cal.monthsGenitive||cal.months,upperMonths=cal._upperMonths,upperMonthsGen=cal._upperMonthsGen;upperMonths||(cal._upperMonths=upperMonths=[toUpperArray(months.names),toUpperArray(months.namesAbbr)],cal._upperMonthsGen=upperMonthsGen=[toUpperArray(monthsGen.names),toUpperArray(monthsGen.namesAbbr)]),value=toUpper(value);var i=arrayIndexOf(abbr?upperMonths[1]:upperMonths[0],value);return i<0&&(i=arrayIndexOf(abbr?upperMonthsGen[1]:upperMonthsGen[0],value)),i},getParseRegExp=function(cal,format){var re=cal._parseRegExp;if(re){var reFormat=re[format];if(reFormat)return reFormat}else cal._parseRegExp=re={};for(var match,expFormat=expandFormat(cal,format).replace(/([\^\$\.\*\+\?\|\[\]\(\)\{\}])/g,"\\\\$1"),regexp=["^"],groups=[],index=0,quoteCount=0,tokenRegExp=getTokenRegExp();null!==(match=tokenRegExp.exec(expFormat));){var preMatch=expFormat.slice(index,match.index);if(index=tokenRegExp.lastIndex,quoteCount+=appendPreOrPostMatch(preMatch,regexp),quoteCount%2)regexp.push(match[0]);else{var add,m=match[0],len=m.length;switch(m){case"dddd":case"ddd":case"MMMM":case"MMM":case"gg":case"g":add="(\\D+)";break;case"tt":case"t":add="(\\D*)";break;case"yyyy":case"fff":case"ff":case"f":add="(\\d{"+len+"})";break;case"dd":case"d":case"MM":case"M":case"yy":case"y":case"HH":case"H":case"hh":case"h":case"mm":case"m":case"ss":case"s":add="(\\d\\d?)";break;case"zzz":add="([+-]?\\d\\d?:\\d{2})";break;case"zz":case"z":add="([+-]?\\d\\d?)";break;case"/":add="(\\"+cal["/"]+")";break;default:throw"Invalid date format pattern '"+m+"'."}add&&regexp.push(add),groups.push(match[0])}}appendPreOrPostMatch(expFormat.slice(index),regexp),regexp.push("$");var regexpStr=regexp.join("").replace(/\s+/g,"\\s+"),parseRegExp={regExp:regexpStr,groups:groups};return re[format]=parseRegExp},outOfRange=function(value,low,high){return value<low||value>high},toUpper=function(value){return value.split("Â ").join(" ").toUpperCase()},toUpperArray=function(arr){for(var results=[],i=0,l=arr.length;i<l;i++)results[i]=toUpper(arr[i]);return results},parseExact=function(value,format,culture){value=trim(value);var cal=culture.calendar,parseInfo=getParseRegExp(cal,format),match=new RegExp(parseInfo.regExp).exec(value);if(null===match)return null;for(var hourOffset,groups=parseInfo.groups,era=null,year=null,month=null,date=null,weekDay=null,hour=0,min=0,sec=0,msec=0,tzMinOffset=null,pmHour=!1,j=0,jl=groups.length;j<jl;j++){var matchGroup=match[j+1];if(matchGroup){var current=groups[j],clength=current.length,matchInt=parseInt(matchGroup,10);switch(current){case"dd":case"d":if(date=matchInt,outOfRange(date,1,31))return null;break;case"MMM":case"MMMM":if(month=getMonthIndex(cal,matchGroup,3===clength),outOfRange(month,0,11))return null;break;case"M":case"MM":if(month=matchInt-1,outOfRange(month,0,11))return null;break;case"y":case"yy":case"yyyy":if(year=clength<4?expandYear(cal,matchInt):matchInt,outOfRange(year,0,9999))return null;break;case"h":case"hh":if(hour=matchInt,12===hour&&(hour=0),outOfRange(hour,0,11))return null;break;case"H":case"HH":if(hour=matchInt,outOfRange(hour,0,23))return null;break;case"m":case"mm":if(min=matchInt,outOfRange(min,0,59))return null;break;case"s":case"ss":if(sec=matchInt,outOfRange(sec,0,59))return null;break;case"tt":case"t":if(pmHour=cal.PM&&(matchGroup===cal.PM[0]||matchGroup===cal.PM[1]||matchGroup===cal.PM[2]),!pmHour&&(!cal.AM||matchGroup!==cal.AM[0]&&matchGroup!==cal.AM[1]&&matchGroup!==cal.AM[2]))return null;break;case"f":case"ff":case"fff":if(msec=matchInt*Math.pow(10,3-clength),outOfRange(msec,0,999))return null;break;case"ddd":case"dddd":if(weekDay=getDayIndex(cal,matchGroup,3===clength),outOfRange(weekDay,0,6))return null;break;case"zzz":var offsets=matchGroup.split(/:/);if(2!==offsets.length)return null;if(hourOffset=parseInt(offsets[0],10),outOfRange(hourOffset,-12,13))return null;var minOffset=parseInt(offsets[1],10);if(outOfRange(minOffset,0,59))return null;tzMinOffset=60*hourOffset+(startsWith(matchGroup,"-")?-minOffset:minOffset);break;case"z":case"zz":if(hourOffset=matchInt,outOfRange(hourOffset,-12,13))return null;tzMinOffset=60*hourOffset;break;case"g":case"gg":var eraName=matchGroup;if(!eraName||!cal.eras)return null;eraName=trim(eraName.toLowerCase());for(var i=0,l=cal.eras.length;i<l;i++)if(eraName===cal.eras[i].name.toLowerCase()){era=i;break}if(null===era)return null}}}var defaultYear,result=new Date,convert=cal.convert;if(defaultYear=convert?convert.fromGregorian(result)[0]:result.getFullYear(),null===year?year=defaultYear:cal.eras&&(year+=cal.eras[era||0].offset),null===month&&(month=0),null===date&&(date=1),convert){if(result=convert.toGregorian(year,month,date),null===result)return null}else{if(result.setFullYear(year,month,date),result.getDate()!==date)return null;if(null!==weekDay&&result.getDay()!==weekDay)return null}if(pmHour&&hour<12&&(hour+=12),result.setHours(hour,min,sec,msec),null!==tzMinOffset){var adjustedMin=result.getMinutes()-(tzMinOffset+result.getTimezoneOffset());result.setHours(result.getHours()+parseInt(adjustedMin/60,10),adjustedMin%60)}return result}}(),parseNegativePattern=function(value,nf,negativePattern){var ret,neg=nf["-"],pos=nf["+"];switch(negativePattern){case"n -":neg=" "+neg,pos=" "+pos;case"n-":endsWith(value,neg)?ret=["-",value.substr(0,value.length-neg.length)]:endsWith(value,pos)&&(ret=["+",value.substr(0,value.length-pos.length)]);break;case"- n":neg+=" ",pos+=" ";case"-n":startsWith(value,neg)?ret=["-",value.substr(neg.length)]:startsWith(value,pos)&&(ret=["+",value.substr(pos.length)]);break;case"(n)":startsWith(value,"(")&&endsWith(value,")")&&(ret=["-",value.substr(1,value.length-2)])}return ret||["",value]},Globalize.prototype.findClosestCulture=function(cultureSelector){return Globalize.findClosestCulture.call(this,cultureSelector)},Globalize.prototype.format=function(value,format,cultureSelector){return Globalize.format.call(this,value,format,cultureSelector)},Globalize.prototype.localize=function(key,cultureSelector){return Globalize.localize.call(this,key,cultureSelector)},Globalize.prototype.parseInt=function(value,radix,cultureSelector){return Globalize.parseInt.call(this,value,radix,cultureSelector)},Globalize.prototype.parseFloat=function(value,radix,cultureSelector){return Globalize.parseFloat.call(this,value,radix,cultureSelector)},Globalize.prototype.culture=function(cultureSelector){return Globalize.culture.call(this,cultureSelector)},Globalize.addCultureInfo=function(cultureName,baseCultureName,info){var base={},isNew=!1;"string"!=typeof cultureName?(info=cultureName,cultureName=this.culture().name,base=this.cultures[cultureName]):"string"!=typeof baseCultureName?(info=baseCultureName,isNew=null==this.cultures[cultureName],base=this.cultures[cultureName]||this.cultures["default"]):(isNew=!0,base=this.cultures[baseCultureName]),this.cultures[cultureName]=extend(!0,{},base,info),isNew&&(this.cultures[cultureName].calendar=this.cultures[cultureName].calendars.standard)},Globalize.findClosestCulture=function(name){var match;if(!name)return this.findClosestCulture(this.cultureSelector)||this.cultures["default"];if("string"==typeof name&&(name=name.split(",")),isArray(name)){var lang,i,cultures=this.cultures,list=name,l=list.length,prioritized=[];for(i=0;i<l;i++){name=trim(list[i]);var pri,parts=name.split(";");lang=trim(parts[0]),1===parts.length?pri=1:(name=trim(parts[1]),0===name.indexOf("q=")?(name=name.substr(2),pri=parseFloat(name),pri=isNaN(pri)?0:pri):pri=1),prioritized.push({lang:lang,pri:pri})}for(prioritized.sort(function(a,b){return a.pri<b.pri?1:-1}),i=0;i<l;i++)if(lang=prioritized[i].lang,match=cultures[lang])return match;for(i=0;i<l;i++)for(lang=prioritized[i].lang;;){var index=lang.lastIndexOf("-");if(index===-1)break;if(lang=lang.substr(0,index),match=cultures[lang])return match}for(i=0;i<l;i++){lang=prioritized[i].lang;for(var cultureKey in cultures){var culture=cultures[cultureKey];if(culture.language==lang)return culture}}}else if("object"==typeof name)return name;return match||null},Globalize.format=function(value,format,cultureSelector){return culture=this.findClosestCulture(cultureSelector),value instanceof Date?value=formatDate(value,format,culture):"number"==typeof value&&(value=formatNumber(value,format,culture)),value},Globalize.localize=function(key,cultureSelector){return this.findClosestCulture(cultureSelector).messages[key]||this.cultures["default"].messages[key]},Globalize.parseDate=function(value,formats,culture){culture=this.findClosestCulture(culture);var date,prop,patterns;if(formats){if("string"==typeof formats&&(formats=[formats]),formats.length)for(var i=0,l=formats.length;i<l;i++){var format=formats[i];if(format&&(date=parseExact(value,format,culture)))break}}else{patterns=culture.calendar.patterns;for(prop in patterns)if(date=parseExact(value,patterns[prop],culture))break}return date||null},Globalize.parseInt=function(value,radix,cultureSelector){return truncate(Globalize.parseFloat(value,radix,cultureSelector))},Globalize.parseFloat=function(value,radix,cultureSelector){"number"!=typeof radix&&(cultureSelector=radix,radix=10);var culture=this.findClosestCulture(cultureSelector),ret=NaN,nf=culture.numberFormat;if(value.indexOf(culture.numberFormat.currency.symbol)>-1&&(value=value.replace(culture.numberFormat.currency.symbol,""),value=value.replace(culture.numberFormat.currency["."],culture.numberFormat["."])),value=trim(value),regexInfinity.test(value))ret=parseFloat(value);else if(!radix&&regexHex.test(value))ret=parseInt(value,16);else{var signInfo=parseNegativePattern(value,nf,nf.pattern[0]),sign=signInfo[0],num=signInfo[1];""===sign&&"(n)"!==nf.pattern[0]&&(signInfo=parseNegativePattern(value,nf,"(n)"),sign=signInfo[0],num=signInfo[1]),""===sign&&"-n"!==nf.pattern[0]&&(signInfo=parseNegativePattern(value,nf,"-n"),sign=signInfo[0],num=signInfo[1]),sign=sign||"+";var exponent,intAndFraction,exponentPos=num.indexOf("e");exponentPos<0&&(exponentPos=num.indexOf("E")),exponentPos<0?(intAndFraction=num,exponent=null):(intAndFraction=num.substr(0,exponentPos),exponent=num.substr(exponentPos+1));var integer,fraction,decSep=nf["."],decimalPos=intAndFraction.indexOf(decSep);decimalPos<0?(integer=intAndFraction,fraction=null):(integer=intAndFraction.substr(0,decimalPos),fraction=intAndFraction.substr(decimalPos+decSep.length));var groupSep=nf[","];integer=integer.split(groupSep).join("");var altGroupSep=groupSep.replace(/\u00A0/g," ");groupSep!==altGroupSep&&(integer=integer.split(altGroupSep).join(""));var p=sign+integer;if(null!==fraction&&(p+="."+fraction),null!==exponent){var expSignInfo=parseNegativePattern(exponent,nf,"-n");p+="e"+(expSignInfo[0]||"+")+expSignInfo[1]}regexParseFloat.test(p)&&(ret=parseFloat(p))}return ret},Globalize.culture=function(cultureSelector){return"undefined"!=typeof cultureSelector&&(this.cultureSelector=cultureSelector),this.findClosestCulture(cultureSelector)||this.culture["default"]}}(this),function(sb,Globalize){"use strict";Globalize.addCultureInfo(sb.i18n.culture.toISOString(),"default",{calendars:{standard:{patterns:{t:"HH:mm",T:"HH:mm:ss"}}}})}(this.sb,this.Globalize),function(sb,Globalize){"use strict";Globalize.culture(sb.i18n.culture.toISOString()),sb.console.info("Set Globalize culture to: "+sb.i18n.culture.toISOString())}(this.sb,this.Globalize),Globalize.convert=function(){var kmToMiles=function(km){return.621371*km},milesToKm=function(miles){return 1.60934*miles};return{kmToMiles:kmToMiles,milesToKm:milesToKm}}(),Globalize.utilities=function(){var a=function(c,e,i){var b,g,d,f=[],h=new Date;return c?(e=e||":",i=i||"t",f=c.split(e),b=parseInt(f[0],10),g=parseInt(f[1],10),d=parseInt(f[2],10),isNaN(b)||isNaN(g)||isNaN(d)?c:(h.setHours(b),h.setMinutes(g),h.setSeconds(d),Globalize.format(h,i))):""};return{formatTime:a}}(),InfoBox.prototype=new google.maps.OverlayView,InfoBox.prototype.createInfoBoxDiv_=function(){var i,events,bw,me=this,cancelHandler=function(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()},ignoreHandler=function(e){e.returnValue=!1,e.preventDefault&&e.preventDefault(),me.enableEventPropagation_||cancelHandler(e)};if(!this.div_){if(this.div_=document.createElement("div"),this.setBoxStyle_(),"undefined"==typeof this.content_.nodeType?this.div_.innerHTML=this.getCloseBoxImg_()+this.content_:(this.div_.innerHTML=this.getCloseBoxImg_(),this.div_.appendChild(this.content_)),this.getPanes()[this.pane_].appendChild(this.div_),this.addClickHandler_(),this.div_.style.width?this.fixedWidthSet_=!0:0!==this.maxWidth_&&this.div_.offsetWidth>this.maxWidth_?(this.div_.style.width=this.maxWidth_,this.div_.style.overflow="auto",this.fixedWidthSet_=!0):(bw=this.getBoxWidths_(),this.div_.style.width=this.div_.offsetWidth-bw.left-bw.right+"px",this.fixedWidthSet_=!1),this.panBox_(this.disableAutoPan_),!this.enableEventPropagation_){for(this.eventListeners_=[],events=["mousedown","mouseover","mouseout","mouseup","click","dblclick","touchstart","touchend","touchmove"],i=0;i<events.length;i++)this.eventListeners_.push(google.maps.event.addDomListener(this.div_,events[i],cancelHandler));this.eventListeners_.push(google.maps.event.addDomListener(this.div_,"mouseover",function(e){this.style.cursor="default"}))}this.contextListener_=google.maps.event.addDomListener(this.div_,"contextmenu",ignoreHandler),google.maps.event.trigger(this,"domready")}},InfoBox.prototype.getCloseBoxImg_=function(){var img="";return""!==this.closeBoxURL_&&(img="<img",img+=" src='"+this.closeBoxURL_+"'",img+=" align=right",img+=" style='",img+=" position: relative;",img+=" cursor: pointer;",img+=" margin: "+this.closeBoxMargin_+";",img+="'>"),img},InfoBox.prototype.addClickHandler_=function(){var closeBox;""!==this.closeBoxURL_?(closeBox=this.div_.firstChild,this.closeListener_=google.maps.event.addDomListener(closeBox,"click",this.getCloseClickHandler_())):this.closeListener_=null},InfoBox.prototype.getCloseClickHandler_=function(){var me=this;return function(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation(),google.maps.event.trigger(me,"closeclick"),me.close()}},InfoBox.prototype.panBox_=function(disablePan){var map,bounds,xOffset=0,yOffset=0;if(!disablePan&&(map=this.getMap(),map instanceof google.maps.Map)){map.getBounds().contains(this.position_)||map.setCenter(this.position_),bounds=map.getBounds();var mapDiv=map.getDiv(),mapWidth=mapDiv.offsetWidth,mapHeight=mapDiv.offsetHeight,iwOffsetX=this.pixelOffset_.width,iwOffsetY=this.pixelOffset_.height,iwWidth=this.div_.offsetWidth,iwHeight=this.div_.offsetHeight,padX=this.infoBoxClearance_.width,padY=this.infoBoxClearance_.height,pixPosition=this.getProjection().fromLatLngToContainerPixel(this.position_);if(pixPosition.x<-iwOffsetX+padX?xOffset=pixPosition.x+iwOffsetX-padX:pixPosition.x+iwWidth+iwOffsetX+padX>mapWidth&&(xOffset=pixPosition.x+iwWidth+iwOffsetX+padX-mapWidth),
this.alignBottom_?pixPosition.y<-iwOffsetY+padY+iwHeight?yOffset=pixPosition.y+iwOffsetY-padY-iwHeight:pixPosition.y+iwOffsetY+padY>mapHeight&&(yOffset=pixPosition.y+iwOffsetY+padY-mapHeight):pixPosition.y<-iwOffsetY+padY?yOffset=pixPosition.y+iwOffsetY-padY:pixPosition.y+iwHeight+iwOffsetY+padY>mapHeight&&(yOffset=pixPosition.y+iwHeight+iwOffsetY+padY-mapHeight),0!==xOffset||0!==yOffset){map.getCenter();map.panBy(xOffset,yOffset)}}},InfoBox.prototype.setBoxStyle_=function(){var i,boxStyle;if(this.div_){this.div_.className=this.boxClass_,this.div_.style.cssText="",boxStyle=this.boxStyle_;for(i in boxStyle)boxStyle.hasOwnProperty(i)&&(this.div_.style[i]=boxStyle[i]);"undefined"!=typeof this.div_.style.opacity&&""!==this.div_.style.opacity&&(this.div_.style.filter="alpha(opacity="+100*this.div_.style.opacity+")"),this.div_.style.position="absolute",this.div_.style.visibility="hidden",null!==this.zIndex_&&(this.div_.style.zIndex=this.zIndex_)}},InfoBox.prototype.getBoxWidths_=function(){var computedStyle,bw={top:0,bottom:0,left:0,right:0},box=this.div_;return document.defaultView&&document.defaultView.getComputedStyle?(computedStyle=box.ownerDocument.defaultView.getComputedStyle(box,""),computedStyle&&(bw.top=parseInt(computedStyle.borderTopWidth,10)||0,bw.bottom=parseInt(computedStyle.borderBottomWidth,10)||0,bw.left=parseInt(computedStyle.borderLeftWidth,10)||0,bw.right=parseInt(computedStyle.borderRightWidth,10)||0)):document.documentElement.currentStyle&&box.currentStyle&&(bw.top=parseInt(box.currentStyle.borderTopWidth,10)||0,bw.bottom=parseInt(box.currentStyle.borderBottomWidth,10)||0,bw.left=parseInt(box.currentStyle.borderLeftWidth,10)||0,bw.right=parseInt(box.currentStyle.borderRightWidth,10)||0),bw},InfoBox.prototype.onRemove=function(){this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)},InfoBox.prototype.draw=function(){this.createInfoBoxDiv_();var pixPosition=this.getProjection().fromLatLngToDivPixel(this.position_);this.div_.style.left=pixPosition.x+this.pixelOffset_.width+"px",this.alignBottom_?this.div_.style.bottom=-(pixPosition.y+this.pixelOffset_.height)+"px":this.div_.style.top=pixPosition.y+this.pixelOffset_.height+"px",this.isHidden_?this.div_.style.visibility="hidden":this.div_.style.visibility="visible"},InfoBox.prototype.setOptions=function(opt_opts){"undefined"!=typeof opt_opts.boxClass&&(this.boxClass_=opt_opts.boxClass,this.setBoxStyle_()),"undefined"!=typeof opt_opts.boxStyle&&(this.boxStyle_=opt_opts.boxStyle,this.setBoxStyle_()),"undefined"!=typeof opt_opts.content&&this.setContent(opt_opts.content),"undefined"!=typeof opt_opts.disableAutoPan&&(this.disableAutoPan_=opt_opts.disableAutoPan),"undefined"!=typeof opt_opts.maxWidth&&(this.maxWidth_=opt_opts.maxWidth),"undefined"!=typeof opt_opts.pixelOffset&&(this.pixelOffset_=opt_opts.pixelOffset),"undefined"!=typeof opt_opts.alignBottom&&(this.alignBottom_=opt_opts.alignBottom),"undefined"!=typeof opt_opts.position&&this.setPosition(opt_opts.position),"undefined"!=typeof opt_opts.zIndex&&this.setZIndex(opt_opts.zIndex),"undefined"!=typeof opt_opts.closeBoxMargin&&(this.closeBoxMargin_=opt_opts.closeBoxMargin),"undefined"!=typeof opt_opts.closeBoxURL&&(this.closeBoxURL_=opt_opts.closeBoxURL),"undefined"!=typeof opt_opts.infoBoxClearance&&(this.infoBoxClearance_=opt_opts.infoBoxClearance),"undefined"!=typeof opt_opts.isHidden&&(this.isHidden_=opt_opts.isHidden),"undefined"!=typeof opt_opts.visible&&(this.isHidden_=!opt_opts.visible),"undefined"!=typeof opt_opts.enableEventPropagation&&(this.enableEventPropagation_=opt_opts.enableEventPropagation),this.div_&&this.draw()},InfoBox.prototype.setContent=function(content){this.content_=content,this.div_&&(this.closeListener_&&(google.maps.event.removeListener(this.closeListener_),this.closeListener_=null),this.fixedWidthSet_||(this.div_.style.width=""),"undefined"==typeof content.nodeType?this.div_.innerHTML=this.getCloseBoxImg_()+content:(this.div_.innerHTML=this.getCloseBoxImg_(),this.div_.appendChild(content)),this.fixedWidthSet_||(this.div_.style.width=this.div_.offsetWidth+"px","undefined"==typeof content.nodeType?this.div_.innerHTML=this.getCloseBoxImg_()+content:(this.div_.innerHTML=this.getCloseBoxImg_(),this.div_.appendChild(content))),this.addClickHandler_()),google.maps.event.trigger(this,"content_changed")},InfoBox.prototype.setPosition=function(latlng){this.position_=latlng,this.div_&&this.draw(),google.maps.event.trigger(this,"position_changed")},InfoBox.prototype.setZIndex=function(index){this.zIndex_=index,this.div_&&(this.div_.style.zIndex=index),google.maps.event.trigger(this,"zindex_changed")},InfoBox.prototype.setVisible=function(isVisible){this.isHidden_=!isVisible,this.div_&&(this.div_.style.visibility=this.isHidden_?"hidden":"visible")},InfoBox.prototype.getContent=function(){return this.content_},InfoBox.prototype.getPosition=function(){return this.position_},InfoBox.prototype.getZIndex=function(){return this.zIndex_},InfoBox.prototype.getVisible=function(){var isVisible;return isVisible="undefined"!=typeof this.getMap()&&null!==this.getMap()&&!this.isHidden_},InfoBox.prototype.show=function(){this.isHidden_=!1,this.div_&&(this.div_.style.visibility="visible")},InfoBox.prototype.hide=function(){this.isHidden_=!0,this.div_&&(this.div_.style.visibility="hidden")},InfoBox.prototype.open=function(map,anchor){var me=this;anchor&&(this.position_=anchor.getPosition(),this.moveListener_=google.maps.event.addListener(anchor,"position_changed",function(){me.setPosition(this.getPosition())})),this.setMap(map),this.div_&&this.panBox_()},InfoBox.prototype.close=function(){var i;if(this.closeListener_&&(google.maps.event.removeListener(this.closeListener_),this.closeListener_=null),this.eventListeners_){for(i=0;i<this.eventListeners_.length;i++)google.maps.event.removeListener(this.eventListeners_[i]);this.eventListeners_=null}this.moveListener_&&(google.maps.event.removeListener(this.moveListener_),this.moveListener_=null),this.contextListener_&&(google.maps.event.removeListener(this.contextListener_),this.contextListener_=null),this.setMap(null)},sb.namespace("sb.storeloc.MercatorProjection"),sb.storeloc.MercatorProjection=function(){"use strict";function bound(value,opt_min,opt_max){return null!==opt_min&&(value=Math.max(value,opt_min)),null!==opt_max&&(value=Math.min(value,opt_max)),value}function degreesToRadians(deg){return deg*(Math.PI/180)}function MercatorProjection(){this.pixelOrigin_=new google.maps.Point(TILE_SIZE/2,TILE_SIZE/2),this.pixelsPerLonDegree_=TILE_SIZE/360,this.pixelsPerLonRadian_=TILE_SIZE/(2*Math.PI)}var TILE_SIZE=256;return MercatorProjection.prototype.fromLatLngToPoint=function(latLng){var siny,self=this,point=new google.maps.Point(0,0),origin=self.pixelOrigin_;return point.x=origin.x+latLng.lng()*self.pixelsPerLonDegree_,siny=bound(Math.sin(degreesToRadians(latLng.lat())),-.9999,.9999),point.y=origin.y+.5*Math.log((1+siny)/(1-siny))*-self.pixelsPerLonRadian_,point},MercatorProjection}(),function($,configData){"use strict";sb.namespace("sb.storeloc"),sb.storeloc.getOAuthToken=function(options){var ajaxOptions={url:"/resources/apitkn",async:!1,cache:!1,timeout:configData.storeLocatorOpenApiRequestTimeout};_.extend(ajaxOptions,options),$.ajax(ajaxOptions)}}(jQuery,sb.storeloc.configData),function(){function createReduce(dir){function iterator(obj,iteratee,memo,keys,index,length){for(;index>=0&&index<length;index+=dir){var currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo}return function(obj,iteratee,memo,context){iteratee=optimizeCb(iteratee,context,4);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=dir>0?0:length-1;return arguments.length<3&&(memo=obj[keys?keys[index]:index],index+=dir),iterator(obj,iteratee,memo,keys,index,length)}}function createPredicateIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);for(var length=getLength(array),index=dir>0?0:length-1;index>=0&&index<length;index+=dir)if(predicate(array[index],index,array))return index;return-1}}function createIndexFinder(dir,predicateFind,sortedIndex){return function(array,item,idx){var i=0,length=getLength(array);if("number"==typeof idx)dir>0?i=idx>=0?idx:Math.max(idx+length,i):length=idx>=0?Math.min(idx+1,length):idx+length+1;else if(sortedIndex&&idx&&length)return idx=sortedIndex(array,item),array[idx]===item?idx:-1;if(item!==item)return idx=predicateFind(slice.call(array,i,length),_.isNaN),idx>=0?idx+i:-1;for(idx=dir>0?i:length-1;idx>=0&&idx<length;idx+=dir)if(array[idx]===item)return idx;return-1}}function collectNonEnumProps(obj,keys){var nonEnumIdx=nonEnumerableProps.length,constructor=obj.constructor,proto=_.isFunction(constructor)&&constructor.prototype||ObjProto,prop="constructor";for(_.has(obj,prop)&&!_.contains(keys,prop)&&keys.push(prop);nonEnumIdx--;)prop=nonEnumerableProps[nonEnumIdx],prop in obj&&obj[prop]!==proto[prop]&&!_.contains(keys,prop)&&keys.push(prop)}var root=this,previousUnderscore=root._,ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype,push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind,nativeCreate=Object.create,Ctor=function(){},_=function(obj){return obj instanceof _?obj:this instanceof _?void(this._wrapped=obj):new _(obj)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=_),exports._=_):root._=_,_.VERSION="1.8.3";var optimizeCb=function(func,context,argCount){if(void 0===context)return func;switch(null==argCount?3:argCount){case 1:return function(value){return func.call(context,value)};case 2:return function(value,other){return func.call(context,value,other)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}},cb=function(value,context,argCount){return null==value?_.identity:_.isFunction(value)?optimizeCb(value,context,argCount):_.isObject(value)?_.matcher(value):_.property(value)};_.iteratee=function(value,context){return cb(value,context,1/0)};var createAssigner=function(keysFunc,undefinedOnly){return function(obj){var length=arguments.length;if(length<2||null==obj)return obj;for(var index=1;index<length;index++)for(var source=arguments[index],keys=keysFunc(source),l=keys.length,i=0;i<l;i++){var key=keys[i];undefinedOnly&&void 0!==obj[key]||(obj[key]=source[key])}return obj}},baseCreate=function(prototype){if(!_.isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);Ctor.prototype=prototype;var result=new Ctor;return Ctor.prototype=null,result},property=function(key){return function(obj){return null==obj?void 0:obj[key]}},MAX_ARRAY_INDEX=Math.pow(2,53)-1,getLength=property("length"),isArrayLike=function(collection){var length=getLength(collection);return"number"==typeof length&&length>=0&&length<=MAX_ARRAY_INDEX};_.each=_.forEach=function(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj))for(i=0,length=obj.length;i<length;i++)iteratee(obj[i],i,obj);else{var keys=_.keys(obj);for(i=0,length=keys.length;i<length;i++)iteratee(obj[keys[i]],keys[i],obj)}return obj},_.map=_.collect=function(obj,iteratee,context){iteratee=cb(iteratee,context);for(var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,results=Array(length),index=0;index<length;index++){var currentKey=keys?keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results},_.reduce=_.foldl=_.inject=createReduce(1),_.reduceRight=_.foldr=createReduce(-1),_.find=_.detect=function(obj,predicate,context){var key;if(key=isArrayLike(obj)?_.findIndex(obj,predicate,context):_.findKey(obj,predicate,context),void 0!==key&&key!==-1)return obj[key]},_.filter=_.select=function(obj,predicate,context){var results=[];return predicate=cb(predicate,context),_.each(obj,function(value,index,list){predicate(value,index,list)&&results.push(value)}),results},_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(cb(predicate)),context)},_.every=_.all=function(obj,predicate,context){predicate=cb(predicate,context);for(var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return!1}return!0},_.some=_.any=function(obj,predicate,context){predicate=cb(predicate,context);for(var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return!0}return!1},_.contains=_.includes=_.include=function(obj,item,fromIndex,guard){return isArrayLike(obj)||(obj=_.values(obj)),("number"!=typeof fromIndex||guard)&&(fromIndex=0),_.indexOf(obj,item,fromIndex)>=0},_.invoke=function(obj,method){var args=slice.call(arguments,2),isFunc=_.isFunction(method);return _.map(obj,function(value){var func=isFunc?method:value[method];return null==func?func:func.apply(value,args)})},_.pluck=function(obj,key){return _.map(obj,_.property(key))},_.where=function(obj,attrs){return _.filter(obj,_.matcher(attrs))},_.findWhere=function(obj,attrs){return _.find(obj,_.matcher(attrs))},_.max=function(obj,iteratee,context){var value,computed,result=-(1/0),lastComputed=-(1/0);if(null==iteratee&&null!=obj){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++)value=obj[i],value>result&&(result=value)}else iteratee=cb(iteratee,context),_.each(obj,function(value,index,list){computed=iteratee(value,index,list),(computed>lastComputed||computed===-(1/0)&&result===-(1/0))&&(result=value,lastComputed=computed)});return result},_.min=function(obj,iteratee,context){var value,computed,result=1/0,lastComputed=1/0;if(null==iteratee&&null!=obj){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++)value=obj[i],value<result&&(result=value)}else iteratee=cb(iteratee,context),_.each(obj,function(value,index,list){computed=iteratee(value,index,list),(computed<lastComputed||computed===1/0&&result===1/0)&&(result=value,lastComputed=computed)});return result},_.shuffle=function(obj){for(var rand,set=isArrayLike(obj)?obj:_.values(obj),length=set.length,shuffled=Array(length),index=0;index<length;index++)rand=_.random(0,index),rand!==index&&(shuffled[index]=shuffled[rand]),shuffled[rand]=set[index];return shuffled},_.sample=function(obj,n,guard){return null==n||guard?(isArrayLike(obj)||(obj=_.values(obj)),obj[_.random(obj.length-1)]):_.shuffle(obj).slice(0,Math.max(0,n))},_.sortBy=function(obj,iteratee,context){return iteratee=cb(iteratee,context),_.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iteratee(value,index,list)}}).sort(function(left,right){var a=left.criteria,b=right.criteria;if(a!==b){if(a>b||void 0===a)return 1;if(a<b||void 0===b)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iteratee,context){var result={};return iteratee=cb(iteratee,context),_.each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)}),result}};_.groupBy=group(function(result,value,key){_.has(result,key)?result[key].push(value):result[key]=[value]}),_.indexBy=group(function(result,value,key){result[key]=value}),_.countBy=group(function(result,value,key){_.has(result,key)?result[key]++:result[key]=1}),_.toArray=function(obj){return obj?_.isArray(obj)?slice.call(obj):isArrayLike(obj)?_.map(obj,_.identity):_.values(obj):[]},_.size=function(obj){return null==obj?0:isArrayLike(obj)?obj.length:_.keys(obj).length},_.partition=function(obj,predicate,context){predicate=cb(predicate,context);var pass=[],fail=[];return _.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)}),[pass,fail]},_.first=_.head=_.take=function(array,n,guard){if(null!=array)return null==n||guard?array[0]:_.initial(array,array.length-n)},_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(null==n||guard?1:n)))},_.last=function(array,n,guard){if(null!=array)return null==n||guard?array[array.length-1]:_.rest(array,Math.max(0,array.length-n))},_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,null==n||guard?1:n)},_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,startIndex){for(var output=[],idx=0,i=startIndex||0,length=getLength(input);i<length;i++){var value=input[i];if(isArrayLike(value)&&(_.isArray(value)||_.isArguments(value))){shallow||(value=flatten(value,shallow,strict));var j=0,len=value.length;for(output.length+=len;j<len;)output[idx++]=value[j++]}else strict||(output[idx++]=value)}return output};_.flatten=function(array,shallow){return flatten(array,shallow,!1)},_.without=function(array){return _.difference(array,slice.call(arguments,1))},_.uniq=_.unique=function(array,isSorted,iteratee,context){_.isBoolean(isSorted)||(context=iteratee,iteratee=isSorted,isSorted=!1),null!=iteratee&&(iteratee=cb(iteratee,context));for(var result=[],seen=[],i=0,length=getLength(array);i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;isSorted?(i&&seen===computed||result.push(value),seen=computed):iteratee?_.contains(seen,computed)||(seen.push(computed),result.push(value)):_.contains(result,value)||result.push(value)}return result},_.union=function(){return _.uniq(flatten(arguments,!0,!0))},_.intersection=function(array){for(var result=[],argsLength=arguments.length,i=0,length=getLength(array);i<length;i++){var item=array[i];if(!_.contains(result,item)){for(var j=1;j<argsLength&&_.contains(arguments[j],item);j++);j===argsLength&&result.push(item)}}return result},_.difference=function(array){var rest=flatten(arguments,!0,!0,1);return _.filter(array,function(value){return!_.contains(rest,value)})},_.zip=function(){return _.unzip(arguments)},_.unzip=function(array){for(var length=array&&_.max(array,getLength).length||0,result=Array(length),index=0;index<length;index++)result[index]=_.pluck(array,index);return result},_.object=function(list,values){for(var result={},i=0,length=getLength(list);i<length;i++)values?result[list[i]]=values[i]:result[list[i][0]]=list[i][1];return result},_.findIndex=createPredicateIndexFinder(1),_.findLastIndex=createPredicateIndexFinder(-1),_.sortedIndex=function(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);for(var value=iteratee(obj),low=0,high=getLength(array);low<high;){var mid=Math.floor((low+high)/2);iteratee(array[mid])<value?low=mid+1:high=mid}return low},_.indexOf=createIndexFinder(1,_.findIndex,_.sortedIndex),_.lastIndexOf=createIndexFinder(-1,_.findLastIndex),_.range=function(start,stop,step){null==stop&&(stop=start||0,start=0),step=step||1;for(var length=Math.max(Math.ceil((stop-start)/step),0),range=Array(length),idx=0;idx<length;idx++,start+=step)range[idx]=start;return range};var executeBound=function(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype),result=sourceFunc.apply(self,args);return _.isObject(result)?result:self};_.bind=function(func,context){if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");var args=slice.call(arguments,2),bound=function(){return executeBound(func,bound,context,this,args.concat(slice.call(arguments)))};return bound},_.partial=function(func){var boundArgs=slice.call(arguments,1),bound=function(){for(var position=0,length=boundArgs.length,args=Array(length),i=0;i<length;i++)args[i]=boundArgs[i]===_?arguments[position++]:boundArgs[i];for(;position<arguments.length;)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound},_.bindAll=function(obj){var i,key,length=arguments.length;if(length<=1)throw new Error("bindAll must be passed function names");for(i=1;i<length;i++)key=arguments[i],obj[key]=_.bind(obj[key],obj);return obj},_.memoize=function(func,hasher){var memoize=function(key){var cache=memoize.cache,address=""+(hasher?hasher.apply(this,arguments):key);return _.has(cache,address)||(cache[address]=func.apply(this,arguments)),cache[address]};return memoize.cache={},memoize},_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)},_.defer=_.partial(_.delay,_,1),_.throttle=function(func,wait,options){var context,args,result,timeout=null,previous=0;options||(options={});var later=function(){previous=options.leading===!1?0:_.now(),timeout=null,result=func.apply(context,args),timeout||(context=args=null)};return function(){var now=_.now();previous||options.leading!==!1||(previous=now);var remaining=wait-(now-previous);return context=this,args=arguments,remaining<=0||remaining>wait?(timeout&&(clearTimeout(timeout),timeout=null),previous=now,result=func.apply(context,args),timeout||(context=args=null)):timeout||options.trailing===!1||(timeout=setTimeout(later,remaining)),result}},_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result,later=function(){var last=_.now()-timestamp;last<wait&&last>=0?timeout=setTimeout(later,wait-last):(timeout=null,immediate||(result=func.apply(context,args),timeout||(context=args=null)))};return function(){context=this,args=arguments,timestamp=_.now();var callNow=immediate&&!timeout;return timeout||(timeout=setTimeout(later,wait)),callNow&&(result=func.apply(context,args),context=args=null),result}},_.wrap=function(func,wrapper){return _.partial(wrapper,func)},_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}},_.compose=function(){var args=arguments,start=args.length-1;return function(){for(var i=start,result=args[start].apply(this,arguments);i--;)result=args[i].call(this,result);return result}},_.after=function(times,func){return function(){if(--times<1)return func.apply(this,arguments)}},_.before=function(times,func){var memo;return function(){return--times>0&&(memo=func.apply(this,arguments)),times<=1&&(func=null),memo}},_.once=_.partial(_.before,2);var hasEnumBug=!{toString:null}.propertyIsEnumerable("toString"),nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)_.has(obj,key)&&keys.push(key);return hasEnumBug&&collectNonEnumProps(obj,keys),keys},_.allKeys=function(obj){if(!_.isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);return hasEnumBug&&collectNonEnumProps(obj,keys),keys},_.values=function(obj){for(var keys=_.keys(obj),length=keys.length,values=Array(length),i=0;i<length;i++)values[i]=obj[keys[i]];return values},_.mapObject=function(obj,iteratee,context){iteratee=cb(iteratee,context);for(var currentKey,keys=_.keys(obj),length=keys.length,results={},index=0;index<length;index++)currentKey=keys[index],results[currentKey]=iteratee(obj[currentKey],currentKey,obj);return results},_.pairs=function(obj){for(var keys=_.keys(obj),length=keys.length,pairs=Array(length),i=0;i<length;i++)pairs[i]=[keys[i],obj[keys[i]]];return pairs},_.invert=function(obj){for(var result={},keys=_.keys(obj),i=0,length=keys.length;i<length;i++)result[obj[keys[i]]]=keys[i];return result},_.functions=_.methods=function(obj){var names=[];for(var key in obj)_.isFunction(obj[key])&&names.push(key);return names.sort()},_.extend=createAssigner(_.allKeys),_.extendOwn=_.assign=createAssigner(_.keys),_.findKey=function(obj,predicate,context){predicate=cb(predicate,context);for(var key,keys=_.keys(obj),i=0,length=keys.length;i<length;i++)if(key=keys[i],predicate(obj[key],key,obj))return key},_.pick=function(object,oiteratee,context){var iteratee,keys,result={},obj=object;if(null==obj)return result;_.isFunction(oiteratee)?(keys=_.allKeys(obj),iteratee=optimizeCb(oiteratee,context)):(keys=flatten(arguments,!1,!1,1),iteratee=function(value,key,obj){return key in obj},obj=Object(obj));for(var i=0,length=keys.length;i<length;i++){var key=keys[i],value=obj[key];iteratee(value,key,obj)&&(result[key]=value)}return result},_.omit=function(obj,iteratee,context){if(_.isFunction(iteratee))iteratee=_.negate(iteratee);else{var keys=_.map(flatten(arguments,!1,!1,1),String);iteratee=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iteratee,context)},_.defaults=createAssigner(_.allKeys,!0),_.create=function(prototype,props){var result=baseCreate(prototype);return props&&_.extendOwn(result,props),result},_.clone=function(obj){return _.isObject(obj)?_.isArray(obj)?obj.slice():_.extend({},obj):obj},_.tap=function(obj,interceptor){return interceptor(obj),obj},_.isMatch=function(object,attrs){var keys=_.keys(attrs),length=keys.length;if(null==object)return!length;for(var obj=Object(object),i=0;i<length;i++){var key=keys[i];if(attrs[key]!==obj[key]||!(key in obj))return!1}return!0};var eq=function(a,b,aStack,bStack){if(a===b)return 0!==a||1/a===1/b;if(null==a||null==b)return a===b;a instanceof _&&(a=a._wrapped),b instanceof _&&(b=b._wrapped);var className=toString.call(a);if(className!==toString.call(b))return!1;switch(className){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!==+a?+b!==+b:0===+a?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}var areArrays="[object Array]"===className;if(!areArrays){if("object"!=typeof a||"object"!=typeof b)return!1;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&"constructor"in a&&"constructor"in b)return!1}aStack=aStack||[],bStack=bStack||[];for(var length=aStack.length;length--;)if(aStack[length]===a)return bStack[length]===b;if(aStack.push(a),bStack.push(b),areArrays){if(length=a.length,length!==b.length)return!1;for(;length--;)if(!eq(a[length],b[length],aStack,bStack))return!1}else{var key,keys=_.keys(a);if(length=keys.length,_.keys(b).length!==length)return!1;for(;length--;)if(key=keys[length],!_.has(b,key)||!eq(a[key],b[key],aStack,bStack))return!1}return aStack.pop(),bStack.pop(),!0};_.isEqual=function(a,b){return eq(a,b)},_.isEmpty=function(obj){return null==obj||(isArrayLike(obj)&&(_.isArray(obj)||_.isString(obj)||_.isArguments(obj))?0===obj.length:0===_.keys(obj).length)},_.isElement=function(obj){return!(!obj||1!==obj.nodeType)},_.isArray=nativeIsArray||function(obj){return"[object Array]"===toString.call(obj)},_.isObject=function(obj){var type=typeof obj;return"function"===type||"object"===type&&!!obj},_.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(name){_["is"+name]=function(obj){return toString.call(obj)==="[object "+name+"]"}}),_.isArguments(arguments)||(_.isArguments=function(obj){return _.has(obj,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(_.isFunction=function(obj){return"function"==typeof obj||!1}),_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))},_.isNaN=function(obj){return _.isNumber(obj)&&obj!==+obj},_.isBoolean=function(obj){return obj===!0||obj===!1||"[object Boolean]"===toString.call(obj)},_.isNull=function(obj){return null===obj},_.isUndefined=function(obj){return void 0===obj},_.has=function(obj,key){return null!=obj&&hasOwnProperty.call(obj,key)},_.noConflict=function(){return root._=previousUnderscore,this},_.identity=function(value){return value},_.constant=function(value){return function(){return value}},_.noop=function(){},_.property=property,_.propertyOf=function(obj){return null==obj?function(){}:function(key){return obj[key]}},_.matcher=_.matches=function(attrs){return attrs=_.extendOwn({},attrs),function(obj){return _.isMatch(obj,attrs)}},_.times=function(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum},_.random=function(min,max){return null==max&&(max=min,min=0),min+Math.floor(Math.random()*(max-min+1))},_.now=Date.now||function(){return(new Date).getTime()};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},unescapeMap=_.invert(escapeMap),createEscaper=function(map){var escaper=function(match){return map[match]},source="(?:"+_.keys(map).join("|")+")",testRegexp=RegExp(source),replaceRegexp=RegExp(source,"g");return function(string){return string=null==string?"":""+string,testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}};_.escape=createEscaper(escapeMap),_.unescape=createEscaper(unescapeMap),_.result=function(object,property,fallback){var value=null==object?void 0:object[property];return void 0===value&&(value=fallback),_.isFunction(value)?value.call(object):value};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id},_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/,escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},escaper=/\\|'|\r|\n|\u2028|\u2029/g,escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,settings,oldSettings){!settings&&oldSettings&&(settings=oldSettings),settings=_.defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g"),index=0,source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){return source+=text.slice(index,offset).replace(escaper,escapeChar),index=offset+match.length,escape?source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'":interpolate?source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'":evaluate&&(source+="';\n"+evaluate+"\n__p+='"),match}),source+="';\n",settings.variable||(source="with(obj||{}){\n"+source+"}\n"),source="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){throw e.source=source,e}var template=function(data){return render.call(this,data,_)},argument=settings.variable||"obj";return template.source="function("+argument+"){\n"+source+"}",template},_.chain=function(obj){var instance=_(obj);return instance._chain=!0,instance};var result=function(instance,obj){return instance._chain?_(obj).chain():obj};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];return push.apply(args,arguments),result(this,func.apply(_,args))}})},_.mixin(_),_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;return method.apply(obj,arguments),"shift"!==name&&"splice"!==name||0!==obj.length||delete obj[0],result(this,obj)}}),_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result(this,method.apply(this._wrapped,arguments))}}),_.prototype.value=function(){return this._wrapped},_.prototype.valueOf=_.prototype.toJSON=_.prototype.value,_.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return _})}.call(this),function(root,factory){if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(_,$,exports){root.Backbone=factory(root,exports,_,$)});else if("undefined"!=typeof exports){var _=require("underscore");
factory(root,exports,_)}else root.Backbone=factory(root,{},root._,root.jQuery||root.Zepto||root.ender||root.$)}(this,function(root,Backbone,_,$){var previousBackbone=root.Backbone,array=[],slice=(array.push,array.slice);array.splice;Backbone.VERSION="1.1.2",Backbone.$=$,Backbone.noConflict=function(){return root.Backbone=previousBackbone,this},Backbone.emulateHTTP=!1,Backbone.emulateJSON=!1;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);return events.push({callback:callback,context:context,ctx:context||this}),this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this,once=_.once(function(){self.off(name,once),callback.apply(this,arguments)});return once._callback=callback,this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context)return this._events=void 0,this;for(names=name?[name]:_.keys(this._events),i=0,l=names.length;i<l;i++)if(name=names[i],events=this._events[name]){if(this._events[name]=retain=[],callback||context)for(j=0,k=events.length;j<k;j++)ev=events[j],(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context)&&retain.push(ev);retain.length||delete this._events[name]}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name],allEvents=this._events.all;return events&&triggerEvents(events,args),allEvents&&triggerEvents(allEvents,arguments),this},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;callback||"object"!=typeof name||(callback=this),obj&&((listeningTo={})[obj._listenId]=obj);for(var id in listeningTo)obj=listeningTo[id],obj.off(name,callback,this),(remove||_.isEmpty(obj._events))&&delete this._listeningTo[id];return this}},eventSplitter=/\s+/,eventsApi=function(obj,action,name,rest){if(!name)return!0;if("object"==typeof name){for(var key in name)obj[action].apply(obj,[key,name[key]].concat(rest));return!1}if(eventSplitter.test(name)){for(var names=name.split(eventSplitter),i=0,l=names.length;i<l;i++)obj[action].apply(obj,[names[i]].concat(rest));return!1}return!0},triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx);return;case 1:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:for(;++i<l;)(ev=events[i]).callback.apply(ev.ctx,args);return}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={}),id=obj._listenId||(obj._listenId=_.uniqueId("l"));return listeningTo[id]=obj,callback||"object"!=typeof name||(callback=this),obj[implementation](name,callback,this),this}}),Events.bind=Events.on,Events.unbind=Events.off,_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={}),this.cid=_.uniqueId("c"),this.attributes={},options.collection&&(this.collection=options.collection),options.parse&&(attrs=this.parse(attrs,options)||{}),attrs=_.defaults({},attrs,_.result(this,"defaults")),this.set(attrs,options),this.changed={},this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return null!=this.get(attr)},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(null==key)return this;if("object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options||(options={}),!this._validate(attrs,options))return!1;unset=options.unset,silent=options.silent,changes=[],changing=this._changing,this._changing=!0,changing||(this._previousAttributes=_.clone(this.attributes),this.changed={}),current=this.attributes,prev=this._previousAttributes,this.idAttribute in attrs&&(this.id=attrs[this.idAttribute]);for(attr in attrs)val=attrs[attr],_.isEqual(current[attr],val)||changes.push(attr),_.isEqual(prev[attr],val)?delete this.changed[attr]:this.changed[attr]=val,unset?delete current[attr]:current[attr]=val;if(!silent){changes.length&&(this._pending=options);for(var i=0,l=changes.length;i<l;i++)this.trigger("change:"+changes[i],this,current[changes[i]],options)}if(changing)return this;if(!silent)for(;this._pending;)options=this._pending,this._pending=!1,this.trigger("change",this,options);return this._pending=!1,this._changing=!1,this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:!0}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:!0}))},hasChanged:function(attr){return null==attr?!_.isEmpty(this.changed):_.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return!!this.hasChanged()&&_.clone(this.changed);var val,changed=!1,old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff)_.isEqual(old[attr],val=diff[attr])||((changed||(changed={}))[attr]=val);return changed},previous:function(attr){return null!=attr&&this._previousAttributes?this._previousAttributes[attr]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){options=options?_.clone(options):{},void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){return!!model.set(model.parse(resp,options),options)&&(success&&success(model,resp,options),void model.trigger("sync",model,resp,options))},wrapError(this,options),this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(null==key||"object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options=_.extend({validate:!0},options),attrs&&!options.wait){if(!this.set(attrs,options))return!1}else if(!this._validate(attrs,options))return!1;attrs&&options.wait&&(this.attributes=_.extend({},attributes,attrs)),void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);return options.wait&&(serverAttrs=_.extend(attrs||{},serverAttrs)),!(_.isObject(serverAttrs)&&!model.set(serverAttrs,options))&&(success&&success(model,resp,options),void model.trigger("sync",model,resp,options))},wrapError(this,options),method=this.isNew()?"create":options.patch?"patch":"update","patch"===method&&(options.attrs=attrs),xhr=this.sync(method,this,options),attrs&&options.wait&&(this.attributes=attributes),xhr},destroy:function(options){options=options?_.clone(options):{};var model=this,success=options.success,destroy=function(){model.trigger("destroy",model,model.collection,options)};if(options.success=function(resp){(options.wait||model.isNew())&&destroy(),success&&success(model,resp,options),model.isNew()||model.trigger("sync",model,resp,options)},this.isNew())return options.success(),!1;wrapError(this,options);var xhr=this.sync("delete",this,options);return options.wait||destroy(),xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?base:base.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(options){return this._validate({},_.extend(options||{},{validate:!0}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return!0;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;return!error||(this.trigger("invalid",this,error,_.extend(options,{validationError:error})),!1)}});var modelMethods=["keys","values","pairs","invert","pick","omit"];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.attributes),_[method].apply(_,args)}});var Collection=Backbone.Collection=function(models,options){options||(options={}),options.model&&(this.model=options.model),void 0!==options.comparator&&(this.comparator=options.comparator),this._reset(),this.initialize.apply(this,arguments),models&&this.reset(models,_.extend({silent:!0},options))},setOptions={add:!0,remove:!0,merge:!0},addOptions={add:!0,remove:!1};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.extend({merge:!1},options,addOptions))},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models),options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++)model=models[i]=this.get(models[i]),model&&(delete this._byId[model.id],delete this._byId[model.cid],index=this.indexOf(model),this.models.splice(index,1),this.length--,options.silent||(options.index=index,model.trigger("remove",model,this,options)),this._removeReference(model,options));return singular?models[0]:models},set:function(models,options){options=_.defaults({},options,setOptions),options.parse&&(models=this.parse(models,options));var singular=!_.isArray(models);models=singular?models?[models]:[]:_.clone(models);var i,l,id,model,attrs,existing,sort,at=options.at,targetModel=this.model,sortable=this.comparator&&null==at&&options.sort!==!1,sortAttr=_.isString(this.comparator)?this.comparator:null,toAdd=[],toRemove=[],modelMap={},add=options.add,merge=options.merge,remove=options.remove,order=!(sortable||!add||!remove)&&[];for(i=0,l=models.length;i<l;i++){if(attrs=models[i]||{},id=attrs instanceof Model?model=attrs:attrs[targetModel.prototype.idAttribute||"id"],existing=this.get(id))remove&&(modelMap[existing.cid]=!0),merge&&(attrs=attrs===model?model.attributes:attrs,options.parse&&(attrs=existing.parse(attrs,options)),existing.set(attrs,options),sortable&&!sort&&existing.hasChanged(sortAttr)&&(sort=!0)),models[i]=existing;else if(add){if(model=models[i]=this._prepareModel(attrs,options),!model)continue;toAdd.push(model),this._addReference(model,options)}model=existing||model,!order||!model.isNew()&&modelMap[model.id]||order.push(model),modelMap[model.id]=!0}if(remove){for(i=0,l=this.length;i<l;++i)modelMap[(model=this.models[i]).cid]||toRemove.push(model);toRemove.length&&this.remove(toRemove,options)}if(toAdd.length||order&&order.length)if(sortable&&(sort=!0),this.length+=toAdd.length,null!=at)for(i=0,l=toAdd.length;i<l;i++)this.models.splice(at+i,0,toAdd[i]);else{order&&(this.models.length=0);var orderedModels=order||toAdd;for(i=0,l=orderedModels.length;i<l;i++)this.models.push(orderedModels[i])}if(sort&&this.sort({silent:!0}),!options.silent){for(i=0,l=toAdd.length;i<l;i++)(model=toAdd[i]).trigger("add",model,this,options);(sort||order&&order.length)&&this.trigger("sort",this,options)}return singular?models[0]:models},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++)this._removeReference(this.models[i],options);return options.previousModels=this.models,this._reset(),models=this.add(models,_.extend({silent:!0},options)),options.silent||this.trigger("reset",this,options),models},push:function(model,options){return this.add(model,_.extend({at:this.length},options))},pop:function(options){var model=this.at(this.length-1);return this.remove(model,options),model},unshift:function(model,options){return this.add(model,_.extend({at:0},options))},shift:function(options){var model=this.at(0);return this.remove(model,options),model},slice:function(){return slice.apply(this.models,arguments)},get:function(obj){if(null!=obj)return this._byId[obj]||this._byId[obj.id]||this._byId[obj.cid]},at:function(index){return this.models[index]},where:function(attrs,first){return _.isEmpty(attrs)?first?void 0:[]:this[first?"find":"filter"](function(model){for(var key in attrs)if(attrs[key]!==model.get(key))return!1;return!0})},findWhere:function(attrs){return this.where(attrs,!0)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return options||(options={}),_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),options.silent||this.trigger("sort",this,options),this},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){options=options?_.clone(options):{},void 0===options.parse&&(options.parse=!0);var success=options.success,collection=this;return options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options),success&&success(collection,resp,options),collection.trigger("sync",collection,resp,options)},wrapError(this,options),this.sync("read",this,options)},create:function(model,options){if(options=options?_.clone(options):{},!(model=this._prepareModel(model,options)))return!1;options.wait||this.add(model,options);var collection=this,success=options.success;return options.success=function(model,resp){options.wait&&collection.add(model,options),success&&success(model,resp,options)},model.save(null,options),model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(attrs,options){if(attrs instanceof Model)return attrs;options=options?_.clone(options):{},options.collection=this;var model=new this.model(attrs,options);return model.validationError?(this.trigger("invalid",this,model.validationError,options),!1):model},_addReference:function(model,options){this._byId[model.cid]=model,null!=model.id&&(this._byId[model.id]=model),model.collection||(model.collection=this),model.on("all",this._onModelEvent,this)},_removeReference:function(model,options){this===model.collection&&delete model.collection,model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){("add"!==event&&"remove"!==event||collection===this)&&("destroy"===event&&this.remove(model,options),model&&event==="change:"+model.idAttribute&&(delete this._byId[model.previous(model.idAttribute)],null!=model.id&&(this._byId[model.id]=model)),this.trigger.apply(this,arguments))}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.models),_[method].apply(_,args)}});var attributeMethods=["groupBy","countBy","sortBy","indexBy"];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)}});var View=Backbone.View=function(options){this.cid=_.uniqueId("view"),options||(options={}),_.extend(this,_.pick(options,viewOptions)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},delegateEventSplitter=/^(\S+)\s*(.*)$/,viewOptions=["model","collection","el","id","attributes","className","tagName","events"];_.extend(View.prototype,Events,{tagName:"div",$:function(selector){return this.$el.find(selector)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(element,delegate){return this.$el&&this.undelegateEvents(),this.$el=element instanceof Backbone.$?element:Backbone.$(element),this.el=this.$el[0],delegate!==!1&&this.delegateEvents(),this},delegateEvents:function(events){if(!events&&!(events=_.result(this,"events")))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(_.isFunction(method)||(method=this[events[key]]),method){var match=key.match(delegateEventSplitter),eventName=match[1],selector=match[2];method=_.bind(method,this),eventName+=".delegateEvents"+this.cid,""===selector?this.$el.on(eventName,method):this.$el.on(eventName,selector,method)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(_.result(this,"el"),!1);else{var attrs=_.extend({},_.result(this,"attributes"));this.id&&(attrs.id=_.result(this,"id")),this.className&&(attrs["class"]=_.result(this,"className"));var $el=Backbone.$("<"+_.result(this,"tagName")+">").attr(attrs);this.setElement($el,!1)}}}),Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(options.url||(params.url=_.result(model,"url")||urlError()),null!=options.data||!model||"create"!==method&&"update"!==method&&"patch"!==method||(params.contentType="application/json",params.data=JSON.stringify(options.attrs||model.toJSON(options))),options.emulateJSON&&(params.contentType="application/x-www-form-urlencoded",params.data=params.data?{model:params.data}:{}),options.emulateHTTP&&("PUT"===type||"DELETE"===type||"PATCH"===type)){params.type="POST",options.emulateJSON&&(params.data._method=type);var beforeSend=options.beforeSend;options.beforeSend=function(xhr){if(xhr.setRequestHeader("X-HTTP-Method-Override",type),beforeSend)return beforeSend.apply(this,arguments)}}"GET"===params.type||options.emulateJSON||(params.processData=!1),"PATCH"===params.type&&noXhrPatch&&(params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var xhr=options.xhr=Backbone.ajax(_.extend(params,options));return model.trigger("request",model,xhr,options),xhr};var noXhrPatch=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){options||(options={}),options.routes&&(this.routes=options.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){_.isRegExp(route)||(route=this._routeToRegExp(route)),_.isFunction(name)&&(callback=name,name=""),callback||(callback=this[name]);var router=this;return Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);router.execute(callback,args),router.trigger.apply(router,["route:"+name].concat(args)),router.trigger("route",name,args),Backbone.history.trigger("route",router,name,args)}),this},execute:function(callback,args){callback&&callback.apply(this,args)},navigate:function(fragment,options){return Backbone.history.navigate(fragment,options),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var route,routes=_.keys(this.routes);null!=(route=routes.pop());)this.route(route,this.routes[route])}},_routeToRegExp:function(route){return route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/?]+)"}).replace(splatParam,"([^?]*?)"),new RegExp("^"+route+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param,i){return i===params.length-1?param||null:param?decodeURIComponent(param):null})}});var History=Backbone.History=function(){this.handlers=[],_.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},routeStripper=/^[#\/]|\s+$/g,rootStripper=/^\/+|\/+$/g,isExplorer=/msie [\w.]+/,trailingSlash=/\/$/,pathStripper=/#.*$/;History.started=!1,_.extend(History.prototype,Events,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getFragment:function(fragment,forcePushState){if(null==fragment)if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=decodeURI(this.location.pathname+this.location.search);var root=this.root.replace(trailingSlash,"");fragment.indexOf(root)||(fragment=fragment.slice(root.length))}else fragment=this.getHash();return fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=!0,this.options=_.extend({root:"/"},this.options,options),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment(),docMode=document.documentMode,oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7);if(this.root=("/"+this.root+"/").replace(rootStripper,"/"),oldIE&&this._wantsHashChange){var frame=Backbone.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=frame.hide().appendTo("body")[0].contentWindow,this.navigate(fragment)}this._hasPushState?Backbone.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!oldIE?Backbone.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=fragment;var loc=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&loc.hash&&(this.fragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment))}if(!this.options.silent)return this.loadUrl()},stop:function(){Backbone.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),History.started=!1},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();return current===this.fragment&&this.iframe&&(current=this.getFragment(this.getHash(this.iframe))),current!==this.fragment&&(this.iframe&&this.navigate(current),void this.loadUrl())},loadUrl:function(fragment){return fragment=this.fragment=this.getFragment(fragment),_.any(this.handlers,function(handler){if(handler.route.test(fragment))return handler.callback(fragment),!0})},navigate:function(fragment,options){if(!History.started)return!1;options&&options!==!0||(options={trigger:!!options});var url=this.root+(fragment=this.getFragment(fragment||""));if(fragment=fragment.replace(pathStripper,""),this.fragment!==fragment){if(this.fragment=fragment,""===fragment&&"/"!==url&&(url=url.slice(0,-1)),this._hasPushState)this.history[options.replace?"replaceState":"pushState"]({},document.title,url);else{if(!this._wantsHashChange)return this.location.assign(url);this._updateHash(this.location,fragment,options.replace),this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))&&(options.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,fragment,options.replace))}return options.trigger?this.loadUrl(fragment):void 0}},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else location.hash="#"+fragment}}),Backbone.history=new History;var extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified')},wrapError=function(model,options){var error=options.error;options.error=function(resp){error&&error(model,resp,options),model.trigger("error",model,resp,options)}};return Backbone}),function(){"use strict";sb.namespace("storeloc.eventTracker"),sb.storeloc.eventTracker=_.extend({},Backbone.Events),sb.storeloc.eventTracker.on("trackEvent",function(args){var action=args.action||"",label=args.label||"",value=args.value||(sb&&sb.rwd&&sb.rwd.viewportWidth?sb.rwd.viewportWidth():0);_gaq&&_gaq.push&&action?(_gaq.push(["_trackEvent","StoreLocatorGoogle",action,label,value]),sb.console.log("Event Tracking: action="+action+"; label="+label+"; width="+value)):sb.console.log("Event NOT tracked: action="+action+"; label="+label+"; width="+value)})}(),sb.namespace("storeloc.Navigation"),sb.storeloc.Navigation=function(){"use strict";var Navigation=Backbone.Model.extend({defaults:{showSchedule:!1,updateUrl:!0},closeInfoWindow:function(){this.trigger("change:closeInfoWindow")},locateUser:function(){this.trigger("locatingUser")},showSearchResults:function(){this.trigger("showSearchResults")},showMap:function(updateUrl){this.set({updateUrl:!!updateUrl}),this.trigger("showMap")},selectResult:function(){this.trigger("change:resultSelected")},selectDirection:function(){this.trigger("change:routeSelected")},closeDetail:function(updateUrl){this.trigger("closeDetail",{updateUrl:!!updateUrl})},showSearchHideDirections:function(updateUrl){this.hideDirectionsDrawerContent(),this.selectSearchDrawer(updateUrl)},selectSearchDrawer:function(updateUrl){this.selectDrawer("search",!!updateUrl)},selectDirectionsDrawer:function(updateUrl){this.selectDrawer("directions",!!updateUrl)},selectDrawer:function(drawer,updateUrl){this.set({selectedDrawer:drawer,prevDrawer:drawer,updateUrl:!!updateUrl})},openDrawer:function(drawer){this.set({openDrawer:drawer,prevDrawer:drawer})},resetSelected:function(){this.set({selectedDrawer:""},{silent:!0})},hideSearchDrawerContent:function(){this.hideDrawerContent("search")},hideDirectionsDrawerContent:function(){this.hideDrawerContent("directions")},hideDrawerContent:function(drawer){this.trigger("hideDrawer",{drawer:drawer})},selectSearchNav:function(){this.selectNav("search")},selectDirectionsNav:function(){this.selectNav("directions")},selectMapNav:function(){this.selectNav("map")},selectNav:function(nav){this.set({selectedNav:nav})}});return Navigation}(),sb.namespace("storeloc.Alert"),sb.storeloc.Alert=function(){"use strict";var Alert=Backbone.Model.extend({defaults:{errOpenAPI:!1,errMapService:!1,errLocationService:!1,errDirectionService:!1,errBrowserAutoGeo:!1,wrnUserPermissionAutoGeo:!1,wrnNoStoresReturned:!1,wrnAllStoresFiltered:!1,wrnNoRoutesFound:!1,wrnBadAddressSearch:!1,wrnBadAddressOrigin:!1,wrnBadAddressDest:!1},resetSearchAlerts:function(){this.set({wrnNoStoresReturned:!1,wrnAllStoresFiltered:!1,wrnBadAddressSearch:!1,errBrowserAutoGeo:!1,wrnUserPermissionAutoGeo:!1,errOpenAPI:!1})},resetDirectionAlerts:function(){this.set({wrnNoRoutesFound:!1,wrnBadAddressOrigin:!1,wrnBadAddressDest:!1,errDirectionService:!1})},resetWarningAlerts:function(){this.set({wrnNoStoresReturned:!1,wrnAllStoresFiltered:!1,wrnUserPermissionAutoGeo:!1})},resetErrorAlerts:function(){this.set({errOpenAPI:!1,errMapService:!1,errLocationService:!1,errDirectionService:!1,errBrowserAutoGeo:!1})}});return Alert}(),sb.namespace("storeloc.SearchResult"),sb.storeloc.SearchResult=function(){"use strict";var SearchResult=Backbone.Model.extend({defaults:{showDetail:!1,detailVisible:!1,showSchedule:!0},initialize:function(){this.listenTo(this,"change:unavailable",this.unavailableDeselect)},unavailableDeselect:function(){this.get("unavailable")&&this.has("selected")&&this.deselect()},select:function(){this.has("selected")||(this.set({selected:!0}),this.collection.select(this),this.trigger("change:resultSelected"))},deselect:function(){this.unset("selected")},showDetail:function(selectDrawer){this.select(),this.set({showDetail:!0},{silent:!0}),this.trigger("change:showDetail",{selectDrawer:selectDrawer,id:this.id})},setDetail:function(visibility){visibility&&this.collection.closeDetail(),this.set({detailVisible:visibility},{silent:!0})}});return SearchResult}(),sb.namespace("storeloc.UserLocation"),sb.storeloc.UserLocation=function(){"use strict";var UserLocation=Backbone.Model.extend({defaults:{userFound:!1,location:null}});return UserLocation}(),sb.namespace("storeloc.MapData"),sb.storeloc.MapData=function($){"use strict";var MapData=Backbone.Model.extend({defaults:{idleHandlerActive:!0,fitBounds:!1,changeCenter:!1},initialize:function(){var configData=this.get("configData");google.maps.visualRefresh=!0,this.minZoom=3,this.maxZoom=19,this.startingLat=configData.storeLocatorStartingLatitude,this.startingLng=configData.storeLocatorStartingLongitude,this.set({zoom:configData.storeLocatorStartingZoomLevel,zoomThreshold:configData.storeLocatorZoomThreshold}),this.uriParserAvailable=_.isFunction($.url)&&_.isFunction($.url().param)},setUriZoom:function(zoom){this.isValidZoom(zoom)&&this.set({uriZoom:parseInt(zoom,10)})},setUriParamZoom:function(){var uriZoom=this.uriParserAvailable?parseInt($.url().param("zoom"),10):null;this.isValidZoom(uriZoom)&&this.set({uriZoom:uriZoom})},isValidZoom:function(zoom){return zoom=parseInt(zoom,10),!isNaN(zoom)&&zoom<=this.maxZoom&&zoom>=this.minZoom},getMapOptions:function(){return{zoom:this.get("zoom"),center:new google.maps.LatLng(this.startingLat,this.startingLng),mapTypeId:google.maps.MapTypeId.ROADMAP,minZoom:this.minZoom,mapTypeControl:!1,panControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},styles:[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit.station.airport",stylers:[{visibility:"off"}]}],zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.TOP_RIGHT},StreetViewControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}}},setCenter:function(center,fitBounds,doNotTrigger){null===fitBounds?this.set({center:center},{silent:!0}):this.set({center:center,fitBounds:fitBounds},{silent:!0}),doNotTrigger||this.trigger("change:mapCenter")},resetCenter:function(centerReset){var center=centerReset||null;this.set({center:center},{silent:!0}),this.trigger("change:center")},zoomedTooFarAway:function(){var threshold=this.get("zoomThreshold"),zoom=this.get("zoom");return isNaN(threshold)||isNaN(zoom)||zoom<=threshold},zoomedTooClose:function(){
var zoom=this.get("zoom");return isNaN(zoom)||zoom>this.maxZoom},initialZoomIsBelowThreshold:function(){var threshold=this.get("zoomThreshold"),initialZoom=this.get("zoom");return initialZoom<=threshold},resetMapResults:function(){this.set({fitBounds:!0}),this.trigger("resetMapResults")}});return MapData}(jQuery),sb.namespace("storeloc.Feature"),sb.storeloc.Feature=function(){"use strict";var Feature=Backbone.Model.extend({defaults:{quantity:0},select:function(silent){this.has("selected")||(this.set({selected:!0},{silent:silent}),this.trigger("featureSelected"))},deselect:function(){this.unset("selected"),this.trigger("featureSelected")}});return Feature}(),sb.namespace("storeloc.Route"),sb.storeloc.Route=function(){"use strict";var Route=Backbone.Model.extend({});return Route}(),sb.namespace("storeloc.Request"),sb.storeloc.Request=function($,configData){"use strict";var Request=Backbone.Model.extend({defaults:{mapInitialize:!0,defaultInitializing:!1,urlRoute:"",useLocationUrl:!1,reloadRoute:"",updateLatLngString:!0},initialize:function(){this.brandsList=configData.storeLocatorBrands.split("|"),this.uriParserAvailable=_.isFunction($.url)&&_.isFunction($.url().param)},requestResults:function(options){this.set({requestType:options.userLocated?"geolocation":"search"}),this.set({location:options.location,userLocated:options.userLocated}),location&&this.trigger("resultsRequestedByLocation",options),options.location&&options.userLocated&&(this.unset("uriLocation",{silent:!0}),this.unset("uriLatLng",{silent:!0}))},requestGeolocation:function(){this.trigger("geolocationRequested")},requestLocationById:function(options){options&&"undefined"!=typeof options.openDrawer&&this.set({openDrawer:options.openDrawer}),this.trigger("resultRequestedById",options)},isValidUriLocation:function(uriLocation){var locationStr=this.trimAndDecode(uriLocation);return locationStr&&locationStr.length},setUriLocation:function(options){var locationStr=this.trimAndDecode(options.location),valid=this.isValidUriLocation(options.location);return valid&&(locationStr===this.get("uriLocation")&&options.id?this.trigger("requestDetailPanel",{id:options.id}):(this.set({uriLocation:locationStr},{silent:!0}),this.trigger("change:uriLocation",{id:options.id})),this.unset("latLngString"),this.unset("uriLatLng",{silent:!0})),valid},setUriBrandCodes:function(uriBrandCodes){var initialBrandCodeSet=this.has("uriBrandCodes"),i=0,l=0,codes=[],validCodes=[];if(!initialBrandCodeSet){if(uriBrandCodes&&uriBrandCodes.length)for(codes=this.trimAndDecode(uriBrandCodes).split(/\s*,\s*/),l=codes.length;i<l;i+=1)this.brandsList.indexOf(codes[i].toUpperCase())!==-1&&validCodes.push(codes[i]);this.set({uriBrandCodes:validCodes.length?validCodes.join(","):""})}},latLngStrToArray:function(uriLatLng){var latLngStr=this.trimAndDecode(uriLatLng),urilatLngArray=latLngStr?latLngStr.split(/\s*,\s*/):[],uriLat=2===urilatLngArray.length?parseFloat(urilatLngArray[0]):null,uriLng=2===urilatLngArray.length?parseFloat(urilatLngArray[1]):null;return this.isValidLatLng(uriLat,uriLng)?this.bug75127TempFix(uriLat,uriLng):[]},bug75127TempFix:function(uriLat,uriLng){var avoidZero=1e-5;return uriLat=0===uriLat?avoidZero:uriLat,uriLng=0===uriLng?avoidZero:uriLng,[uriLat,uriLng]},isValidLatLng:function(uriLat,uriLng){return(uriLat||0===uriLat)&&!isNaN(uriLat)&&uriLat>=-90&&uriLat<=90&&(uriLng||0===uriLng)&&!isNaN(uriLng)&&uriLng>=-180&&uriLng<=180},isValidId:function(id){return this.trimAndDecode(id).match(/^[0-9]+$/)},setUriLatLng:function(options){var googleLatLng=new google.maps.LatLng(options.lat,options.lng);_.isEqual(googleLatLng,this.get("uriLatLng"))&&options.id?this.trigger("requestDetailPanel",{id:options.id}):(this.set({uriLatLng:googleLatLng},{silent:!0}),this.trigger("change:uriLatLng",{id:options.id})),this.unset("locationString"),this.unset("uriLocation",{silent:!0})},setUriLatLngDetailOnly:function(options){this.set({updateLatLngString:!1}),this.setUriLatLng(options)},setUriFeatures:function(features){features?(features=this.trimAndDecode(features).split(/\s*,\s*/),this.set({uriFeatures:features}),this.trigger("featuresOnRoute")):this.set({uriFeatures:[]})},trimAndDecode:function(uriStr){try{return null===uriStr?"":$.trim(decodeURIComponent(uriStr))}catch(err){return sb.console.log("malformed URI component: "+uriStr),""}},setReloadRoute:function(route){this.set({reloadRoute:route},{silent:!0}),this.trigger("change:reloadRoute")}});return Request}(jQuery,sb.storeloc.configData),sb.namespace("storeloc.SearchResults"),sb.storeloc.SearchResults=function($,configData,SearchResult){"use strict";var SearchResults=Backbone.Collection.extend({model:SearchResult,initialize:function(models,options){this.baseUrl=options.url,this.nearestStore=!1,this.parameters={},this.parameters.radius=options.radius,this.parameters.limit=options.limit,this.defaultBrandCode=options.defaultBrandCode,this.apikeyParam=options.apikeyParam,this.resultsVisibility=!0,this.moreResults=!0,this.weekdayNames=options.daysOfWeek,this.holidays=options.holidays},parse:function(response,options){var newStores=[],maxDistance=configData.storeLocatorIsMetric?Globalize.convert.kmToMiles(configData.storeLocatorMaxDistance):configData.storeLocatorMaxDistance,coordinates=null,requestOptions={};if(options&&options.requestOptions&&options.requestOptions.timestamp===this.requestTimestamp){if(_.extend(requestOptions,options.requestOptions),!requestOptions.fetchingById)return response.stores&&_.isArray(response.stores)?(newStores=_.map(response.stores,this.transformStore,this),this.requestedId=requestOptions.id,this.paging=response.paging,response.stores=newStores,this.responseLength=response.stores.length):response.store&&_.isObject(response.store)&&requestOptions.nearestLocationQuery?(this.nearestStore=!1,response.distance<maxDistance?(coordinates=response.store.coordinates,requestOptions.latitude=coordinates.latitude,requestOptions.longitude=coordinates.longitude,requestOptions.nearestLocationQuery=!1,this.trigger("nearestResultFound",requestOptions),this.getNearbyLocations(requestOptions)):this.trigger("change:successFetchingStores"),response.stores=[]):"undefined"!=typeof response.store&&null===response.store&&requestOptions.nearestLocationQuery?(this.responseLength=0,this.trigger("change:successFetchingStores"),response.stores=[]):this.trigger("change:errorFetchingStores"),response.stores;if(!(response.stores&&response.stores.length>0&&response.stores[0].coordinates))return this.trigger("change:invalidLocationById"),response.stores=[],response.stores;this.trigger("fetchedStoreByID",{id:response.stores[0].id,coordinates:response.stores[0].coordinates})}},getNearbyLocations:function(options){var reset=0===this.length,featureParams=[],requestOptions={};this.url=this.baseUrl+"stores/nearby",delete this.parameters.featureCodes,delete this.parameters.Open24x7,featureParams=_.map(options.features,function(feature){return"hrs24"!==feature.get("code")?feature.get("code"):void(this.parameters.Open24x7=!0)},this),featureParams.length&&(this.parameters.featureCodes=featureParams.join(",")),this.moreResults?(this.parameters.latLng=options.latitude+","+options.longitude,this.parameters.ignore="storeNumber,ownershipTypeCode,timeZoneInfo,extendedHours",this.parameters.brandCodes=options.brands||this.defaultBrandCode,this.checkOAuthTimeout()&&this.refreshToken(),this.trigger("change:startFetchingStores"),_.extend(requestOptions,options),this.requestTimestamp=(new Date).getTime(),requestOptions.timestamp=this.requestTimestamp,this.fetch({reset:reset,dataType:"jsonp",data:$.param(this.parameters)+"&"+this.apikeyParam,requestOptions:requestOptions,success:function(collection,response,options){options&&options.requestOptions&&options.requestOptions.timestamp===this.requestTimestamp&&(0===collection.length&&this.nearestStore?options.requestOptions.userLocated?this.trigger("noInitialResultsForUser"):this.getNearestLocation(options.requestOptions):this.trigger("change:successFetchingStores"))}.bind(this),error:function(collection,response,options){options&&options.requestOptions&&options.requestOptions.timestamp===this.requestTimestamp&&this.trigger("change:errorFetchingStores")}.bind(this),complete:function(){this.trigger("change:doneFetchingStores")}.bind(this)})):this.clearResults()},getNearestLocation:function(options){var parameters={},requestOptions={};options&&(this.url=this.baseUrl+"stores/nearest",parameters.latLng=options.latitude+","+options.longitude,this.parameters.featureCodes&&(parameters.featureCodes=this.parameters.featureCodes),this.parameters.Open24x7&&(parameters.Open24x7=this.parameters.Open24x7),parameters.brandCodes=this.parameters.brandCodes,parameters.select="coordinates",this.checkOAuthTimeout()&&this.refreshToken(),this.trigger("change:startFetchingStores"),_.extend(requestOptions,options),this.requestTimestamp=(new Date).getTime(),requestOptions.timestamp=this.requestTimestamp,requestOptions.nearestLocationQuery=!0,this.fetch({dataType:"jsonp",data:$.param(parameters)+"&"+this.apikeyParam,requestOptions:requestOptions,error:function(){requestOptions&&requestOptions.timestamp&&requestOptions.timestamp===this.requestTimestamp&&this.trigger("change:errorFetchingStores")}.bind(this),complete:function(){this.trigger("change:doneFetchingStores")}.bind(this)}))},getLocationById:function(id){var parameters={},requestOptions={};this.url=this.baseUrl+"stores/ids",parameters.ids=id,parameters.select="id,coordinates",this.checkOAuthTimeout()&&this.refreshToken(),this.trigger("change:startFetchingStores"),this.requestTimestamp=(new Date).getTime(),requestOptions.timestamp=this.requestTimestamp,requestOptions.id=id,requestOptions.fetchingById=!0,this.fetch({dataType:"jsonp",data:$.param(parameters)+"&"+this.apikeyParam,requestOptions:requestOptions,error:function(collection,response,options){requestOptions&&requestOptions.timestamp&&requestOptions.timestamp===this.requestTimestamp&&this.trigger("change:errorFetchingStores")}.bind(this),complete:function(){this.trigger("change:doneFetchingStores")}.bind(this)})},select:function(selectedResult){this.selectedResult&&this.deselect(),this.selectedResult=selectedResult},deselect:function(){this.selectedResult&&(this.selectedResult.deselect(),delete this.selectedResult,this.trigger("change:resultsDeselected"))},getSelected:function(){return this.find(function(result){return result.has("selected")})},hasSelected:function(){return this.some(function(result){return result.has("selected")})},allUnavailable:function(){var availableModel=this.find(function(model){return!model.get("unavailable")});return!availableModel},clearResults:function(){this.reset([],{silent:!0})},remove:function(models,options){var allowRemoveAllStores=!options.requestOptions||options.requestOptions.allowRemoveAllStores;(0!==this.responseLength||0===this.responseLength&&allowRemoveAllStores)&&Backbone.Collection.prototype.remove.call(this,models,options)},reset:function(models,options){var i,l;for(i=0,l=this.models.length;i<l;i+=1)this.models[i].trigger("remove");Backbone.Collection.prototype.reset.call(this,models,options)},setResultsVisibility:function(visible){this.resultsVisibility=visible,this.trigger("change:resultsVisibility")},closeDetail:function(){var detailModel=this.findWhere({detailVisible:!0});detailModel&&detailModel.trigger("closeDetail",{updateUrl:!1})},hasDetailVisible:function(){return this.some(function(result){return result.get("detailVisible")})},showDetailPanel:function(options){var model=null;options&&options.id&&"undefined"!=typeof options.openDrawer&&(model=this.get(options.id),model&&model.showDetail(options.openDrawer))},checkOAuthTimeout:function(){var now=(new Date).getTime(),elapsed=Math.ceil((now-sb.storeloc.oAuthTimestamp)/6e4);return elapsed>configData.storeLocatorOpenApiTimeout-1},refreshToken:function(){sb.storeloc.getOAuthToken({success:function(data,status,request){data&&$.trim(data)?(this.apikeyParam="access_token="+data,sb.storeloc.oAuthTimestamp=(new Date).getTime(),sb.console.log("access_token="+data),sb.console.log("timestamp="+sb.storeloc.oAuthTimestamp)):sb.console.log("Couldn't retrieve token")}.bind(this),error:function(request,status,error){}})},transformStore:function(store){var holiday,distance=store.distance,flattenedStore=store.store;return flattenedStore.distance=distance,_.each(flattenedStore.hoursNext7Days,function(schedule,i){var parsedDate=this.parseDate(schedule.date),dayIndex=new Date(Date.UTC(parsedDate.year,parsedDate.month,parsedDate.date)).getUTCDay();flattenedStore.hoursNext7Days[i].dayOfWeek=this.weekdayNames[dayIndex],schedule.open||null===schedule.holidayCode||"BE"===schedule.holidayCode.toUpperCase()?flattenedStore.hoursNext7Days[i].holiday="":(holiday=_.findWhere(this.holidays,{code:schedule.holidayCode}),flattenedStore.hoursNext7Days[i].holiday="undefined"!=typeof holiday?holiday.name:"")},this),flattenedStore},parseDate:function(date){var dateParts=date.split("-");return{year:parseInt(dateParts[0],10),month:parseInt(dateParts[1],10)-1,date:parseInt(dateParts[2],10)}}});return SearchResults}(jQuery,sb.storeloc.configData,sb.storeloc.SearchResult),sb.namespace("storeloc.Features"),sb.storeloc.Features=function(Feature){"use strict";var Features=Backbone.Collection.extend({model:Feature});return Features}(sb.storeloc.Feature),sb.namespace("storeloc.Routes"),sb.storeloc.Routes=function(Route){"use strict";var Routes=Backbone.Collection.extend({model:Route,addRoutes:function(foundRoutes){this.serviceResult=foundRoutes,this.reset(foundRoutes.routes)},clearRoutes:function(){this.reset([],{silent:!0})},setUriDirectionInputs:function(options){var toLocation=options&&options.to?options.to:"",fromLocation=options&&options.from?options.from:"";toLocation.length?this.uriDestination=toLocation:delete this.uriDestination,fromLocation.length?this.uriOrigin=fromLocation:delete this.uriOrgin,this.trigger("change:uriDirectionInputs",{renderRoute:this.uriDestination&&this.uriOrigin})}});return Routes}(sb.storeloc.Route),sb.namespace("storeloc.BaseView"),sb.storeloc.BaseView=function(){"use strict";var BaseView=Backbone.View.extend({EARTH_RADIUS:6371,getDistance:function(posA,posB){var startLat=this.degreesToRadians(posA?posA.lat():0),startLng=this.degreesToRadians(posA?posA.lng():0),endLat=this.degreesToRadians(posB?posB.lat():0),endLng=this.degreesToRadians(posB?posB.lng():0),distance=0;return distance=Math.acos(Math.sin(startLat)*Math.sin(endLat)+Math.cos(startLat)*Math.cos(endLat)*Math.cos(startLng-endLng))*this.EARTH_RADIUS},degreesToRadians:function(degrees){return degrees*Math.PI/180},getRadiusLatLng:function(lat,lng,radius){var startLat=this.degreesToRadians(lat),startLng=this.degreesToRadians(lng),dist=parseFloat(radius)/(1e3*this.EARTH_RADIUS),destAng=this.degreesToRadians(0),destLat=Math.asin(Math.sin(startLat)*Math.cos(dist)+Math.cos(startLat)*Math.sin(dist)*Math.cos(destAng)),destLng=180*(startLng+Math.atan2(Math.sin(destAng)*Math.sin(dist)*Math.cos(startLat),Math.cos(dist)-Math.sin(startLat)*Math.sin(destLat)))/Math.PI;return destLat=180*destLat/Math.PI,new google.maps.LatLng(destLat,destLng)}});return BaseView}(),sb.namespace("storeloc.UserLocationView"),sb.storeloc.UserLocationView=function($,configData,MercatorProjection,BaseView,vent){"use strict";var UserLocationView=BaseView.extend({el:"#findMe",events:{click:"evFindMe"},initialize:function(options){var self=this;this.storeMap=options.map,this.mapData=options.mapData,this.projection=options.projection,this.request=options.request,this.navigation=options.navigation,this.alert=options.alert,this.watchOptions={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4},this.listenTo(this.request,"geolocationRequested",this.geolocateUser),this.projection=new MercatorProjection,this.panorama=this.storeMap.getStreetView(),google.maps.event.addListener(this.panorama,"visible_changed",function(){self.panorama.getVisible()&&(self.$el.hide(),vent.trigger("trackEvent",{action:"StreetView",label:"Visible"}))}),google.maps.event.addListener(this.panorama,"closeclick",function(){self.$el.show(),vent.trigger("trackEvent",{action:"StreetView",label:"Close"})}),google.maps.event.addListener(this.storeMap,"zoom_changed",function(){var found=self.model.get("userFound");found&&self.userMarker&&self.bocMarker&&self.updateBocMarkerIcon()}),"undefined"!=typeof navigator.geolocation&&this.$el.show()},geolocateUser:function(userInitiate){var self=this;"undefined"!=typeof navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(position){var userPosition=new google.maps.LatLng(position.coords.latitude,position.coords.longitude),accuracy=position.coords.accuracy;self.request.set({initialize:!1}),self.watchId&&(navigator.geolocation.clearWatch(self.watchId),self.watchId=null),self.request.requestResults({location:userPosition,userLocated:!0}),self.model.set({location:userPosition,accuracy:accuracy,userFound:!0}),accuracy<=configData.storeLocatorAccuracyThreshold?self.userMarker?self.updateUserMarker(userPosition):self.addUserMarker(userPosition):(self.userMarker||self.bocMarker)&&self.clearUserMarker(),userInitiate?self.navigation.showSearchHideDirections(!0):vent.trigger("trackEvent",{action:"Geolocate",label:"Auto"})},$.proxy(this.displayGeoLocError,this),this.watchOptions)},evFindMe:function(){return this.findMe(!0),vent.trigger("trackEvent",{action:"Geolocate",label:"Find Me"}),!1},findMe:function(userInitiate){return this.navigation.locateUser(),this.geolocateUser(userInitiate),!1},getPixelScale:function(position,radius){var numTiles=1<<this.storeMap.getZoom(),destLatLng=this.getRadiusLatLng(position.lat(),position.lng(),radius),worldDestPoint=new google.maps.Point(0,0),pixelDestPoint=new google.maps.Point(0,0),worldCenterPoint=new google.maps.Point(0,0),pixelCenterPoint=new google.maps.Point(0,0),scale=0;return worldDestPoint=this.projection.fromLatLngToPoint(destLatLng),pixelDestPoint.x=worldDestPoint.x*numTiles,pixelDestPoint.y=worldDestPoint.y*numTiles,worldCenterPoint=this.projection.fromLatLngToPoint(position),pixelCenterPoint.x=worldCenterPoint.x*numTiles,pixelCenterPoint.y=worldCenterPoint.y*numTiles,scale=Math.abs(pixelDestPoint.y-pixelCenterPoint.y)},addUserMarker:function(position){var scale=this.getPixelScale(position,this.model.get("accuracy")),bubble={path:google.maps.SymbolPath.CIRCLE,fillOpacity:.25,fillColor:"#00BDDF",strokeOpacity:.6,strokeColor:"#00BDDF",strokeWeight:1,scale:scale},user={path:google.maps.SymbolPath.CIRCLE,fillOpacity:1,fillColor:"#00BDDF",strokeWeight:0,scale:5},userMarkerOptions={map:this.storeMap,clickable:!1,flat:!0,position:position,icon:user,zIndex:9999},bubbleMarkerOptions={map:this.storeMap,clickable:!1,flat:!0,position:position,icon:bubble,zIndex:9998};this.userMarker=new google.maps.Marker(userMarkerOptions),this.bocMarker=new google.maps.Marker(bubbleMarkerOptions)},updateUserMarker:function(position){this.userMarker&&(this.userMarker.setPosition(position),this.bocMarker.setPosition(position),this.updateBocMarkerIcon())},updateBocMarkerIcon:function(){var position=this.model.get("location"),accuracy=this.model.get("accuracy"),scale=this.getPixelScale(position,accuracy);this.bocMarker.setIcon({path:google.maps.SymbolPath.CIRCLE,fillOpacity:.3,fillColor:"#00BDDF",strokeOpacity:.6,strokeColor:"#00BDDF",strokeWeight:1,scale:scale})},clearUserMarker:function(){this.userMarker&&(this.userMarker.setMap(null),this.userMarker=null),this.bocMarker&&(this.bocMarker.setMap(null),this.bocMarker=null)},displayGeoLocError:function(error){0===error.code||2===error.code||3===error.code?this.alert.set({errBrowserAutoGeo:!0}):1===error.code&&this.alert.set({wrnUserPermissionAutoGeo:!0}),navigator.geolocation.clearWatch(this.watchId),this.watchId=null}});return UserLocationView}(jQuery,sb.storeloc.configData,sb.storeloc.MercatorProjection,sb.storeloc.BaseView,sb.storeloc.eventTracker),sb.namespace("storeloc.FeatureView"),sb.storeloc.FeatureView=function($,vent){"use strict";var FeatureView=Backbone.View.extend({tagName:"li",template:"#feature-template",events:{click:"selectFeature","click input[type=checkbox]":"trackEvent"},initialize:function(options){this.template=_.template($(this.template).html()),this.request=options.request,this.listenTo(this.model,"change:selected",this.toggleSelected),this.listenTo(this.model,"update:quantity",this.updateQuantity),this.listenTo(this.model,"clear:quantity",this.clearQuantity),this.listenTo(this.request,"change:uriFeatures",this.updateFeatureSelection)},render:function(){var html=this.template(this.model.attributes);return this.$el.html(html),this},trackEvent:function(){var checkbox=this.$("input[type=checkbox]"),isChecked=checkbox.is(":checked"),featureCode=checkbox.val();vent.trigger("trackEvent",{action:"Store Features",label:(isChecked?"Checked - ":"Unchecked - ")+featureCode})},selectFeature:function(){this.$("input[type=checkbox]").is(":checked")?this.model.select():this.model.deselect()},toggleSelected:function(){this.model.has("selected")?this.$el.addClass("selected"):this.$el.removeClass("selected")},updateQuantity:function(){var quantity=this.model.get("quantity");this.model.get("selected")?this.$el.find(".quantity").text("("+quantity+")"):this.clearQuantity()},clearQuantity:function(){this.$el.find(".quantity").text("")},updateFeatureSelection:function(){var self=this,features=this.request.get("uriFeatures"),code=this.model.get("code").toLowerCase();this.$("input[type=checkbox]").prop("checked",!1),this.model.deselect(),_.each(features,function(feature){feature.toLowerCase()===code&&(self.$("input[type=checkbox]").prop("checked",!0),self.model.select(!0))})}});return FeatureView}(jQuery,sb.storeloc.eventTracker),sb.namespace("storeloc.FeaturesView"),sb.storeloc.FeaturesView=function(FeatureView,vent){"use strict";var FeaturesView=Backbone.View.extend({el:"#refine",events:{"click a.expandable":"evShowHideFeatures","click #show-results":"evShowResults"},initialize:function(options){this.searchResults=options.results,this.navigation=options.navigation,this.request=options.request,this.expandable=this.$("a.expandable"),this.resultsToggle=this.$("#results-toggle"),this.featureList=this.$("#toggle-store-filters"),this.featureUIBlock=this.$("#block-feature-ui"),this.listenTo(this.collection,"change:selected",this.setCheckedIcon),this.listenTo(this.collection,"featureSelected",this.disableFeatureSelection),this.listenTo(this.searchResults,"reset",this.setFeatureQuantities),this.listenTo(this.searchResults,"change:successFetchingStores",this.enableFeatureSelection),this.listenTo(this.searchResults,"change:errorFetchingStores",this.enableFeatureSelection),this.listenTo(this.searchResults,"add",this.setFeatureQuantities),this.listenTo(this.searchResults,"remove",this.setFeatureQuantities),this.listenTo(this.searchResults,"change:resultsVisibility",this.toggleFeatureQuantityVisibility),this.listenTo(this.searchResults,"change:resultsVisibility",this.toggleFeaturesVisibility),this.listenTo(this.request,"featuresOnRoute",this.evShowHideFeatures),this.render()},evShowHideFeatures:function(){var visible=this.featureList.is(":visible");return this.showHideFeatures(),vent.trigger("trackEvent",{action:"Store Features",label:visible?"Collapse":"Expand"}),!1},showHideFeatures:function(){var show=this.featureList.is(":visible"),className="show";this.featureList.toggle(!show),this.expandable.toggleClass(className,!show),this.navigation.set({featuresExpanded:!show})},evShowResults:function(){this.showResults(),vent.trigger("trackEvent",{action:"Store Features",label:"Mobile - Show Results"})},showResults:function(){this.navigation.showMap(!0)},render:function(){return this.collection.isEmpty()?this.$el.hide():this.addAll(),this},addAll:function(){this.collection.each(this.addOne,this)},addOne:function(feature){var featureView=new FeatureView({model:feature,collection:this.collection,request:this.request});this.$el.find("ul.filters").append(featureView.render().el)},setCheckedIcon:function(){var selectedFeatures=[];selectedFeatures=this.collection.filter(function(feature){return feature.has("selected")}),selectedFeatures.length>0?this.$el.find(".amenities-check").addClass("features-selected"):this.$el.find(".amenities-check").removeClass("features-selected")},setFeatureQuantities:function(){var self=this;this.collection.each(function(feature){feature.trigger("clear:quantity")}),this.collection.each(function(feature){var code=feature.get("code"),filteredResults=[];filteredResults=self.searchResults.filter(function(result){var features=result.get("features"),regularHours=result.get("regularHours"),i=0,l=features.length;if(null!==regularHours&&"hrs24"===code)return!!regularHours.open24x7;for(i;i<l;i+=1)if(features[i].code===code)return!0;return!1}),feature.set({quantity:filteredResults.length}),feature.trigger("update:quantity")})},toggleFeaturesVisibility:function(){this.searchResults.hasDetailVisible()||this.collection.isEmpty()?this.$el.hide():this.$el.show()},toggleFeatureQuantityVisibility:function(){var event=this.searchResults.resultsVisibility&&!this.searchResults.hasDetailVisible()?"update:quantity":"clear:quantity";this.collection.each(function(feature){feature.trigger(event)})},disableFeatureSelection:function(){this.featureUIBlock.addClass("disabled")},enableFeatureSelection:function(){this.featureUIBlock.removeClass("disabled")}});return FeaturesView}(sb.storeloc.FeatureView,sb.storeloc.eventTracker),sb.namespace("storeloc.SearchView"),sb.storeloc.SearchView=function(vent){"use strict";var SearchView=Backbone.View.extend({el:"#search-stores",events:{"submit #searchForm":"suppressSubmit","click #find":"submitSearch","keydown #searchField":"clearSearchErrorMessage"},initialize:function(options){var self=this;this.$searchField=this.$("#searchField"),this.map=options.map,this.navigation=options.navigation,this.request=options.request,this.alert=options.alert,this.autocomplete=new google.maps.places.Autocomplete(document.getElementById("searchField")),this.autocomplete.bindTo("bounds",this.map),this.autocomplete.setTypes(["geocode"]),google.maps.event.addListener(this.autocomplete,"place_changed",function(){self.ac_place=self.autocomplete.getPlace().formatted_address,self.submitSearch()}),this.listenTo(this.navigation,"locatingUser",this.writeSearchInput),this.listenTo(this.request,"change:uriLatLng",this.doUriLatLngSearch),this.listenTo(this.request,"change:uriLocation",this.doUriLocationSearch)},suppressSubmit:function(){return this.$searchField.blur(),!1},submitSearch:function(){var searchAddress=this.ac_place||this.$searchField.val(),searchLabel=this.ac_place?"Autocomplete":this.$searchField.val()?"Inputbox":"Empty";return this.doLocationSearch({addressString:searchAddress,searchLabel:searchLabel}),this.ac_place="",!1},doUriLatLngSearch:function(options){var uriLatLng=this.request.get("uriLatLng");uriLatLng&&this.writeSearchInput(),this.request.get("updateLatLngString")&&this.request.set({latLngString:uriLatLng.lat()+","+uriLatLng.lng()}),this.request.set({updateLatLngString:!0}),this.doSearch({searchString:uriLatLng,isLatLng:!0,id:options.id}),vent.trigger("trackEvent",{action:"Location Search",label:"by URI LatLng"})},doUriLocationSearch:function(options){var uriLocation=this.request.get("uriLocation");uriLocation&&(this.writeSearchInput(uriLocation),this.doLocationSearch({addressString:uriLocation,searchLabel:"URI Location",id:options.id}))},doLocationSearch:function(options){return this.request.set({locationString:options.addressString}),this.doSearch({searchString:options.addressString,isLatLng:!1,id:options.id}),vent.trigger("trackEvent",{action:"Location Search",label:"by "+options.searchLabel}),!1},doSearch:function(options){var self=this,geocoder=new google.maps.Geocoder;options.searchString&&(options.isLatLng&&options.searchString.lat&&options.searchString.lng?self.request.requestResults({location:options.searchString,userLocated:!1,id:options.id}):geocoder.geocode({address:options.searchString},function(results,status){status===google.maps.GeocoderStatus.OK?(self.alert.set({wrnBadAddressSearch:!1,errLocationService:!1}),self.request.requestResults({location:results[0].geometry.location,userLocated:!1,id:options.id})):status===google.maps.GeocoderStatus.ZERO_RESULTS||status===google.maps.GeocoderStatus.INVALID_REQUEST?self.alert.set({wrnBadAddressSearch:!0}):self.alert.set({errLocationService:!0})}))},clearSearchErrorMessage:function(){this.alert.set({wrnBadAddressSearch:!1})},writeSearchInput:function(txt){this.$searchField.val(txt||"")}});return SearchView}(sb.storeloc.eventTracker),sb.namespace("storeloc.DetailView"),sb.storeloc.DetailView=function($,vent){"use strict";var DetailView=Backbone.View.extend({className:"store_detail_overlay",template:"#store-detail-template",operationDetailsTemplate:"#operation-details-template",events:{"click .close_overlay":"evRemoveDetailOverlay","click #store-directions a":"evShowDirections","click #store-address a":"evClickStoreName","click #store-contact a":"evClickPhoneNumber","click #store-hours a":"evClickStoreHours","click #store-amenities a":"evClickStoreAmenities"},initialize:function(options){this.navigation=options.navigation,this.template=_.template($(this.template).html()),this.operationDetailsTemplate=_.template($(this.operationDetailsTemplate).html()),this.model.setDetail(!0),this.model.collection.setResultsVisibility(!1),this.listenTo(this.model,"remove",this.removeDetailOverlay),this.listenTo(this.model,"closeDetail",this.removeDetailOverlay)},render:function(){var operationDetailsHtml="";return this.$el.html(this.template(this.model.attributes)),this.model.get("hoursNext7Days")&&(operationDetailsHtml=this.operationDetailsTemplate(this.model.attributes)),this.$el.find("#store-hours h3").first().after(operationDetailsHtml),this.navigation.get("isSmallScreen")||(this.toggleStoreHours(),this.toggleStoreAmenities()),this},evRemoveDetailOverlay:function(){return this.removeDetailOverlay({updateUrl:!0}),vent.trigger("trackEvent",{action:"Store Details Panel",label:"Close Panel"}),!1},removeDetailOverlay:function(options){var updateUrl=!0;return options&&"undefined"!=typeof options.updateUrl&&(updateUrl=options.updateUrl),this.model.setDetail(!1),this.navigation.closeDetail(updateUrl),this.remove(),!1},evShowDirections:function(){return this.showDirections(),vent.trigger("trackEvent",{action:"Store Details Panel",label:"Directions"}),!1},showDirections:function(){this.model.select(),this.navigation.selectDirectionsDrawer(!0)},evClickStoreHours:function(){var showSchedule=this.$("#show-schedule"),visible=showSchedule.is(":visible");return this.toggleStoreHours(),vent.trigger("trackEvent",{action:"Store Details Panel",label:(visible?"Collapse":"Expand")+" Store Hours"}),!1},toggleStoreHours:function(){var showSchedule=this.$("#show-schedule"),expandable=this.$("#store-hours a"),className="show",visible=showSchedule.is(":visible");return showSchedule.toggle(!visible),expandable.toggleClass(className,!visible),!1},evClickStoreAmenities:function(){var showAmenities=this.$("#show-amenities"),visible=showAmenities.is(":visible");return this.toggleStoreAmenities(),vent.trigger("trackEvent",{action:"Store Details Panel",label:(visible?"Collapse":"Expand")+" Store Features"}),!1},toggleStoreAmenities:function(){var showAmenities=this.$("#show-amenities"),expandable=this.$("#store-amenities a"),className="show",visible=showAmenities.is(":visible");return showAmenities.toggle(!visible),expandable.toggleClass(className,!visible),!1},evClickStoreName:function(){vent.trigger("trackEvent",{action:"Store Details Panel",label:"Store Name"})},evClickPhoneNumber:function(){vent.trigger("trackEvent",{action:"Store Details Panel",label:"Phone Number"})}});return DetailView}(jQuery,sb.storeloc.eventTracker),sb.namespace("storeloc.SearchResultView"),sb.storeloc.SearchResultView=function($,configData,DetailView,vent){"use strict";var SearchResultView=Backbone.View.extend({tagName:"li",className:"result",resultTemplate:"#search-result-template",
distanceTemplate:"#distance-template",detailDistanceTemplate:"#detail-distance-template",operationDetailsTemplate:"#operation-details-template",events:{click:"evSelectResult","click a":"evOpenDetailPanel",mouseenter:"focusOnResult",mouseleave:"blurOnResult"},initialize:function(options){this.navigation=options.navigation,this.userLocation=options.userLocation,this.resultTemplate=_.template($(this.resultTemplate).html()),this.distanceTemplate=_.template($(this.distanceTemplate).html()),this.detailDistanceTemplate=_.template($(this.detailDistanceTemplate).html()),this.operationDetailsTemplate=_.template($(this.operationDetailsTemplate).html()),this.listenTo(this.model,"change:selected",this.toggleSelected),this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model,"change:unavailable",this.toggleUnavailable),this.listenTo(this.model,"change:showDetail",this.showDetail),this.listenTo(this.model,"change:distance",this.updateDistance),this.listenTo(this.model,"change:detailVisible",this.resetDetailVisible),this.listenTo(this.model,"change:showSchedule",this.setShowScheduleFlag),this.setShowScheduleFlag()},render:function(){var html=this.resultTemplate(this.model.attributes),userFound=this.userLocation.get("userFound"),accuracy=this.userLocation.get("accuracy"),distance=this.model.get("distance"),hasDistance=null!==distance&&"undefined"!=typeof distance,distanceHtml="",operationDetailHtml="",addressText="";return this.$el.html(html),this.model.get("showSchedule")&&(operationDetailHtml=this.operationDetailsTemplate(this.model.attributes),this.$el.find(".address").after(operationDetailHtml)),userFound&&hasDistance&&accuracy<=configData.storeLocatorAccuracyThreshold&&(distanceHtml=this.distanceTemplate(this.model.attributes),this.$el.find(".address").after(distanceHtml)),this.$el.find("ul li:not(.optional)").each(function(index,li){addressText+=$.trim($(li).text())+" "}),this.model.addressText=$.trim(addressText),this},evSelectResult:function(){this.selectResult(),vent.trigger("trackEvent",{action:"Store Results",label:"Select Result"})},selectResult:function(){this.model.select(),this.navigation.get("isSmallScreen")&&this.navigation.selectResult()},toggleSelected:function(){var selected_class="selected";this.model.has(selected_class)?this.$el.addClass(selected_class).scrollintoview({duration:"slow",direction:"y"}):this.$el.removeClass(selected_class)},toggleUnavailable:function(){this.$el.toggleClass("unavailable",this.model.get("unavailable"))},evOpenDetailPanel:function(){return this.model.showDetail(!1),vent.trigger("trackEvent",{action:"Store Results",label:"Open Detail Panel"}),!1},openDetailPanel:function(){var detailView=null,userFound=this.userLocation.get("userFound"),accuracy=this.userLocation.get("accuracy"),distanceHtml="";return detailView=new DetailView({model:this.model,navigation:this.navigation,userLocation:this.userLocation}),$(detailView.render().el).insertAfter("#searchForm"),userFound&&accuracy<=configData.storeLocatorAccuracyThreshold&&(distanceHtml=this.detailDistanceTemplate(this.model.attributes),$("#store-directions h3").after(distanceHtml)),!1},showDetail:function(options){options&&options.selectDrawer&&this.navigation.selectSearchDrawer(options.selectDrawer),this.openDetailPanel(),this.model.set({showDetail:!1},{silent:!0})},updateDistance:function(){var html=this.distanceTemplate(this.model.attributes);this.$el.find(".distance").replaceWith(html)},resetDetailVisible:function(){this.model.set({detailVisible:this.model._previousAttributes.detailVisible},{silent:!0})},setShowScheduleFlag:function(){var day,weeklyHours=this.model.get("regularHours"),showSchedule=!1;for(day in weeklyHours)weeklyHours.hasOwnProperty(day)&&null!==weeklyHours[day].open&&weeklyHours[day].open!==!1&&(showSchedule=!0);this.model.set({showSchedule:showSchedule},{silent:!0})},focusOnResult:function(){Modernizr.touch||this.model.set({hover:!0})},blurOnResult:function(){Modernizr.touch||this.model.set({hover:!1})}});return SearchResultView}(jQuery,sb.storeloc.configData,sb.storeloc.DetailView,sb.storeloc.eventTracker),sb.namespace("storeloc.SearchResultsView"),sb.storeloc.SearchResultsView=function(SearchResultView){"use strict";var SearchResultsView=Backbone.View.extend({el:"#searchResults",initialize:function(options){this.navigation=options.navigation,this.userLocation=options.userLocation,this.request=options.request,this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"change:resultsVisibility",this.toggleResultsVisibility),this.listenTo(this.collection,"change:invalidLocationById",this.showSearchHideDirections)},render:function(){return this.addAll(),this},addAll:function(){this.$el.empty(),this.collection.each(this.addOne,this)},addOne:function(searchResult){var resultView=new SearchResultView({model:searchResult,navigation:this.navigation,userLocation:this.userLocation,request:this.request});this.$el.append(resultView.render().el)},showSearchHideDirections:function(){this.navigation.showSearchHideDirections(!0)},toggleResultsVisibility:function(){this.collection.resultsVisibility&&!this.collection.hasDetailVisible()?this.$el.removeClass("hide"):this.$el.addClass("hide")}});return SearchResultsView}(sb.storeloc.SearchResultView),sb.namespace("storeloc.InfoWindowView"),sb.storeloc.InfoWindowView=function($,configData,vent){"use strict";var InfoWindowView=Backbone.View.extend({id:"store-infowindow",events:{"click #infoWinDirections":"evInfoWindowDirections","click #infoWinFullSchedule":"evInfoWindowFullSchedule","click #store-infowindow a":"evInfoWindowStoreName"},template:"#store-infowindow-template",distanceTemplate:"#distance-template",operationDetailsTemplate:"#operation-details-template",initialize:function(options){this.template=_.template($(this.template).html()),this.distanceTemplate=_.template($(this.distanceTemplate).html()),this.operationDetailsTemplate=_.template($(this.operationDetailsTemplate).html()),this.searchResults=options.results,this.request=options.request,this.storeMap=options.map,this.navigation=options.navigation,this.userLocation=options.userLocation,this.listenTo(this.model.collection,"change:resultsDeselected",this.remove),this.listenTo(this.navigation,"change:closeInfoWindow",this.remove)},evInfoWindowDirections:function(){this.selectDirectionsDrawer(),vent.trigger("trackEvent",{action:"InfoWindow",label:"Directions"})},evInfoWindowFullSchedule:function(){this.showStoreDetail(),vent.trigger("trackEvent",{action:"InfoWindow",label:"Full Schedule"})},evInfoWindowStoreName:function(){return this.showStoreDetail(),vent.trigger("trackEvent",{action:"InfoWindow",label:"Store Name"}),!1},render:function(){var html=this.template(this.model.attributes),userFound=this.userLocation.get("userFound"),accuracy=this.userLocation.get("accuracy"),operationDetailsHtml="",distanceHtml="";return this.$el.html(html),this.model.get("showSchedule")&&(operationDetailsHtml=this.operationDetailsTemplate(this.model.attributes),this.$el.find(".telephone").after(operationDetailsHtml)),userFound&&accuracy<=configData.storeLocatorAccuracyThreshold&&(distanceHtml=this.distanceTemplate(this.model.attributes),this.$el.find(".telephone").after(distanceHtml)),this},selectDirectionsDrawer:function(){this.navigation.selectDirectionsDrawer(!0)},showStoreDetail:function(){return this.model.showDetail(!0),!1},remove:function(){this.undelegateEvents(),Backbone.View.prototype.remove.call(this)}});return InfoWindowView}(jQuery,sb.storeloc.configData,sb.storeloc.eventTracker),sb.namespace("storeloc.MapView"),sb.storeloc.MapView=function($,configData,BaseView,InfoWindowView,vent){"use strict";var MapView=BaseView.extend({el:"#map_canvas",events:{transitionend:"handleTransitionend",webkitTransitionEnd:"handleTransitionend",oTransitionEnd:"handleTransitionend",otransitionend:"handleTransitionend"},template:"#store-infowindow-template",initialize:function(options){var self=this;this.navigation=options.navigation,this.storeMap=options.map,this.mapData=options.mapData,this.request=options.request,this.searchResults=options.results,this.routes=options.routes,this.userLocation=options.userLocation,this.zoomThreshold=options.zoomThreshold,this.template=_.template($(this.template).html()),this.markers=[],this.searchResults.setResultsVisibility(this.storeMap.getZoom()>configData.storeLocatorZoomThreshold),this.infoWindow=new InfoBox({alignBottom:!0,pixelOffset:new google.maps.Size((-110),(-55)),zIndex:10}),google.maps.event.addListener(this.infoWindow,"closeclick",function(){self.searchResults.deselect(),vent.trigger("trackEvent",{action:"InfoWindow",label:"Close InfoWindow"})}),google.maps.event.addListener(this.storeMap,"center_changed",function(){self.bug74969TempFix()}),google.maps.event.addListener(this.storeMap,"zoom_changed",function(){var zoomLevel=self.storeMap.getZoom();sb.console.log("zoom: "+zoomLevel),sb.console.log("current center latitude: "+self.storeMap.getCenter().lat()),sb.console.log("current center longitude: "+self.storeMap.getCenter().lng()),self.mapData.set({zoom:zoomLevel}),self.searchResults.moreResults=zoomLevel>self.mapData.get("zoomThreshold"),!self.searchResults.moreResults&&self.searchResults.resultsVisibility&&self.hideResults(),self.searchResults.moreResults&&!self.searchResults.resultsVisibility&&0===self.routes.length&&(self.unhideResults(),self.mapData.get("fitBounds")||self.mapData.resetCenter(self.storeMap.getCenter()))}),google.maps.event.addListener(this.storeMap,"click",function(){self.searchResults.deselect(),vent.trigger("trackEvent",{action:"Map",label:"Click on Map"})}),this.panorama=this.storeMap.getStreetView(),this.panorama.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER},panControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.TOP_RIGHT}}),this.listenTo(this.navigation,"showSearchResults",this.showSearchResults),this.listenTo(this.navigation,"change:openDrawer",this.drawerChanged),this.listenTo(this.navigation,"closeDetail",this.unhideResults),this.listenTo(this.searchResults,"change:resetSearchResults",this.renderResults),this.listenTo(this.searchResults,"change:added",this.addResult),this.listenTo(this.searchResults,"remove",this.removeResult),this.listenTo(this.searchResults,"change:resultSelected",this.openInfoWindow),this.listenTo(this.searchResults,"change:selected",this.closeInfoWindow),this.listenTo(this.searchResults,"change:resultsDeselected",this.closeInfoWindow),this.listenTo(this.searchResults,"change:unavailable",this.toggleMarkerVisibility),this.listenTo(this.searchResults,"change",this.updateDistanceToUser),this.listenTo(this.searchResults,"change:hover",this.hoverMarker),this.listenTo(this.searchResults,"nearestResultFound",this.setMapCenterToNearestStore),this.listenTo(this.routes,"reset",this.hideResults),this.listenTo(this.mapData,"change:mapCenter",this.centerMap),this.listenTo(this.mapData,"change:idleHandlerActive",this.toggleIdleHandler),this.listenTo(this.mapData,"change:drawer",this.refreshMap),this.listenTo(this.mapData,"resetMapResults",this.renderResults),this.listenToOnce(this.request,"setUriParamZoom",this.mapData.setUriParamZoom),this.mapData.zoomedTooFarAway()&&(this.searchResults.moreResults=!1),this.mapData.setCenter(this.storeMap.getCenter(),!1),this.toggleIdleHandler()},bug74969TempFix:function(){var dataCenter=this.mapData.get("center"),mapCenter=this.storeMap.getCenter(),userActionToChangeCenter=this.mapData.get("changeCenter"),openDrawer=this.navigation.get("openDrawer"),inconsistencyThreshold=.001;!userActionToChangeCenter&&"search"===openDrawer&&dataCenter.lat()-mapCenter.lat()===0&&Math.abs(dataCenter.lng()-mapCenter.lng())>inconsistencyThreshold&&(sb.console.log("google map center inconsistent!"),sb.console.log("mapData latlng: "+dataCenter.lat()+","+dataCenter.lng()),sb.console.log("storeMap latlng: "+mapCenter.lat()+","+mapCenter.lng()),this.centerMap())},setMapCenterToNearestStore:function(options){var lat=null,lng=null,center=null;options&&"undefined"!=typeof options.latitude&&"undefined"!=typeof options.longitude&&(lat=options.latitude,lng=options.longitude),this.request.isValidLatLng(lat,lng)&&(center=new google.maps.LatLng(lat,lng),this.mapData.setCenter(center,null,!0))},centerMap:function(){this.storeMap.setCenter(this.mapData.get("center"))},renderResults:function(){var self=this,threshold=configData.storeLocatorIsMetric?Globalize.convert.kmToMiles(configData.storeLocatorSingleStoreFitBoundsThreshold):configData.storeLocatorSingleStoreFitBoundsThreshold,location=null,model=null,coordinates=null,position=null,requestType=this.request.get("requestType"),uriZoom=this.mapData.get("uriZoom");this.closeInfoWindow(),this.placeMarkers(),this.searchResults.each(function(model){self.updateDistanceToUser(model)}),"geolocation"===requestType&&this.navigation.get("isSmallScreen")&&!this.navigation.get("featuresExpanded")&&this.searchResults.length>0&&this.navigation.showMap(!0),uriZoom?(this.storeMap.setZoom(uriZoom),this.mapData.unset("uriZoom"),this.mapData.set({fitBounds:!1})):this.mapData.get("fitBounds")&&this.searchResults.length>1?(this.fitToBounds(),this.mapData.set({fitBounds:!1})):this.mapData.get("fitBounds")&&1===this.searchResults.length&&(model=this.searchResults.at(0),coordinates=model.get("coordinates"),position=new google.maps.LatLng(coordinates.latitude,coordinates.longitude),"search"===requestType?(location=this.request.get("location"),this.bounds.extend(location),this.fitToBounds()):"geolocation"===requestType&&(model.get("distance")<=threshold?this.storeMap.setZoom(configData.storeLocatorSingleStoreZoom):(this.bounds.extend(this.userLocation.get("location")),this.fitToBounds())),this.storeMap.setCenter(position),this.mapData.set({fitBounds:!1}))},addResult:function(result){result&&result.get("added")&&(this.addMarker(result),this.updateDistanceToUser(result))},removeResult:function(result){var id=result.id,removalMarker=_.find(this.markers,function(marker){return marker.store_id===id}),foundIndex=_.indexOf(this.markers,removalMarker);foundIndex>=0&&(this.markers[foundIndex].setMap(null),this.markers.splice(foundIndex,1)),this.closeInfoWindow()},placeMarkers:function(){this.clearMarkers(),this.bounds=new google.maps.LatLngBounds,this.searchResults.each(this.addMarker,this),this.toggleMarkerVisibility()},addMarker:function(result){var coordinates=result.get("coordinates"),markerPosition=new google.maps.LatLng(coordinates.latitude,coordinates.longitude),visibility=!this.mapData.zoomedTooFarAway(),markerOptions={map:this.storeMap,flat:!0,position:markerPosition,icon:{scaledSize:new google.maps.Size(44,67),size:new google.maps.Size(44,67),url:"/static/images/store_locator/location-marker-sm.png"},zIndex:10,visible:visibility},marker=new google.maps.Marker(markerOptions);marker.store_id=result.id,google.maps.event.addListener(marker,"click",function(){result.select(),vent.trigger("trackEvent",{action:"Map",label:"Click Pin"})}),this.markers.push(marker),this.bounds.extend(markerPosition)},clearMarkers:function(){var i=0,l=this.markers.length;for(l;i<l;i+=1)this.markers[i].setMap(null);this.markers=[],this.bounds=null},openInfoWindow:function(){var selectedResult=this.searchResults.getSelected(),coordinates=null,markerPosition=null,infoWindowView=null;this.mapData.set({changeCenter:!1}),this.navigation.closeInfoWindow(),infoWindowView=new InfoWindowView({model:selectedResult,request:this.request,map:this.storeMap,navigation:this.navigation,userLocation:this.userLocation}),coordinates=selectedResult.get("coordinates"),markerPosition=new google.maps.LatLng(coordinates.latitude,coordinates.longitude),this.infoWindow.close(),this.infoWindow.setContent(infoWindowView.render().el),this.infoWindow.setPosition(markerPosition),this.infoWindow.store_id=selectedResult.id,this.infoWindow.open(this.storeMap)},closeInfoWindow:function(){this.searchResults.hasSelected()||this.infoWindow.close()},toggleIdleHandler:function(){var self=this,threshold=configData.storeLocatorIsMetric?Globalize.convert.milesToKm(configData.storeLocatorPanThreshold):configData.storeLocatorPanThreshold;this.mapData.get("idleHandlerActive")?(this.mapIdleHandlerResizeOnly&&google.maps.event.removeListener(this.mapIdleHandlerResizeOnly),this.mapIdleHandler=google.maps.event.addListener(this.storeMap,"idle",function(){var center=self.storeMap.getCenter(),prevCenter=self.mapData.get("center"),centerDelta=self.getDistance(center,prevCenter),currentZoom=self.storeMap.getZoom(),adjustedThreshold=threshold;currentZoom<configData.storeLocatorPanThresholdZoom&&(adjustedThreshold=Math.pow(2,configData.storeLocatorPanThresholdZoom-currentZoom)*threshold),self.mapData.get("changeCenter")&&centerDelta>adjustedThreshold&&self.mapData.set({center:center}),self.mapData.set({changeCenter:!0})}),self.mapData.zoomedTooFarAway()||this.searchResults.setResultsVisibility(!0)):(this.mapIdleHandler&&google.maps.event.removeListener(this.mapIdleHandler),this.mapIdleHandlerResizeOnly=google.maps.event.addListener(this.storeMap,"idle",function(){self.refreshMap()}))},toggleMarkerVisibility:function(){var i=0,l=this.markers.length,marker=null;for(l;i<l;i+=1)marker=this.markers[i],this.toggleOneMarkerVisibility(marker)},toggleOneMarkerVisibility:function(marker){var store=this.searchResults.get(marker.store_id),bool=store&&!store.get("unavailable")&&!this.mapData.zoomedTooFarAway();return marker.setVisible(bool),bool},hideResults:function(){var i=0,l=this.markers.length;for(this.routes.length>0&&this.mapData.set({idleHandlerActive:!1}),l;i<l;i+=1)this.markers[i].setVisible(!1);this.searchResults.setResultsVisibility(!1),this.searchResults.deselect()},unhideResults:function(){var showResults=!this.mapData.zoomedTooFarAway();this.mapData.set({idleHandlerActive:showResults}),this.toggleMarkerVisibility(),this.searchResults.setResultsVisibility(showResults||0===this.markers.length)},handleTransitionend:function(e){"undefined"==typeof e.originalEvent||"margin"!==e.originalEvent.propertyName&&"margin-left"!==e.originalEvent.propertyName||this.refreshMap()},refreshMap:function(){google.maps.event.trigger(this.storeMap,"resize")},drawerChanged:function(){"search"===this.navigation.get("openDrawer")&&this.toggleMarkerVisibility()},showSearchResults:function(){this.searchResults.hasDetailVisible()||this.unhideResults()},updateDistanceToUser:function(model){var coordinates=model.get("coordinates"),location=new google.maps.LatLng(coordinates.latitude,coordinates.longitude),userLocation=this.userLocation.get("location"),newDistance=0;newDistance=Globalize.convert.kmToMiles(this.getDistance(location,userLocation)),model.set({distance:newDistance})},fitToBounds:function(){this.mapData.set({changeCenter:!1}),this.storeMap.fitBounds(this.bounds),this.mapData.zoomedTooFarAway()?this.storeMap.setZoom(configData.storeLocatorZoomThreshold+1):this.mapData.zoomedTooClose()&&this.storeMap.setZoom(configData.storeLocatorSingleStoreZoom)},hoverMarker:function(model){var targetId=model.get("id"),hoverState=model.get("hover"),targetMarker=_.find(this.markers,function(marker){return marker.store_id===targetId});targetMarker&&hoverState?(targetMarker.setIcon({scaledSize:new google.maps.Size(44,67),size:new google.maps.Size(44,67),url:"/static/images/store_locator/location-marker-lg.png"}),targetMarker.setOptions({zIndex:100})):targetMarker&&!hoverState&&(targetMarker.setIcon({scaledSize:new google.maps.Size(44,67),size:new google.maps.Size(44,67),url:"/static/images/store_locator/location-marker-sm.png"}),targetMarker.setOptions({zIndex:10}))}});return MapView}(jQuery,sb.storeloc.configData,sb.storeloc.BaseView,sb.storeloc.InfoWindowView,sb.storeloc.eventTracker),sb.namespace("storeloc.DirectionsView"),sb.storeloc.DirectionsView=function($,configData,vent){"use strict";var DirectionsView=Backbone.View.extend({el:"#directionsContainer",events:{"submit #directionsForm":"suppressSubmit","focus #origin":"clearDirectionInput","focus #destination":"clearDirectionInput","keypress #origin":"clearOrigin","keypress #destination":"clearDestination","blur #origin":"resetDirectionInput","blur #destination":"resetDirectionInput","click #getDirections":"submitSearch","change [name=travelMode]":"changeMode","click #swap-locations":"swapOriginDestination","click #routes div:nth-child(2)":"showDirectionsInfoWindow"},template:"#destination-detail-template",initialize:function(options){this.$destination=this.$("#destination"),this.$origin=this.$("#origin"),this.placeholder=this.$("#directionsForm").data("placeholder"),this.template=_.template($(this.template).html()),this.storeMap=options.map,this.navigation=options.navigation,this.mapData=options.mapData,this.searchResults=options.results,this.userLocation=options.userLocation,this.request=options.request,this.alert=options.alert,this.autocompleteOrigin=new google.maps.places.Autocomplete(document.getElementById("origin")),this.autocompleteOrigin.bindTo("bounds",this.storeMap),this.autocompleteOrigin.setTypes(["geocode"]),this.autocompleteDest=new google.maps.places.Autocomplete(document.getElementById("destination")),this.autocompleteDest.bindTo("bounds",this.storeMap),this.autocompleteDest.setTypes(["geocode"]),this.listenTo(this.collection,"reset",this.placeRoute),this.listenTo(this.collection,"change:uriDirectionInputs",this.setDirectionInputs),this.listenTo(this.searchResults,"change:resetSearchResults",this.clearRouteDisplay),this.listenTo(this.searchResults,"change:selected",this.setDestination),this.listenTo(this.mapData,"change:idleHandlerActive",this.clearRouteOnIdleActive),this.listenTo(this.userLocation,"change:location",this.setOriginInput),this.directionsService=new google.maps.DirectionsService,this.currentMode=google.maps.TravelMode.DRIVING},clearOrigin:function(){this.alert.set({wrnBadAddressOrigin:!1,wrnNoRoutesFound:!1})},clearDestination:function(){this.alert.set({wrnBadAddressDest:!1,wrnNoRoutesFound:!1})},suppressSubmit:function(){return!1},clearDirectionInput:function(e){var target=e.currentTarget;("origin"===target.id&&target.value===this.placeholder&&this.$destination.val()!==this.placeholder||"destination"===target.id&&target.value===this.placeholder&&this.$origin.val()!==this.placeholder)&&(target.value="")},resetDirectionInput:function(e){var target=e.currentTarget;("origin"===target.id&&""===target.value&&this.$destination.val()!==this.placeholder||"destination"===target.id&&""===target.value&&this.$origin.val()!==this.placeholder)&&(target.value=this.placeholder)},setOriginInput:function(){this.userLocation.get("accuracy")<=configData.storeLocatorAccuracyThreshold&&this.$origin.val(this.placeholder)},submitSearch:function(){var origin=this.$origin.val(),destination=this.$destination.val(),travelMode=this.$("[name=travelMode]:checked").val();return origin===this.placeholder?origin=this.userLocation.get("location"):destination===this.placeholder&&(destination=this.userLocation.get("location")),this.getDirections(origin,destination,travelMode),!1},getDirections:function(origin,destination,travelMode){var self=this,geocoder=null,request={origin:origin,destination:destination,provideRouteAlternatives:!0,durationInTraffic:!0,travelMode:google.maps.TravelMode[travelMode],unitSystem:configData.storeLocatorIsMetric?google.maps.UnitSystem.METRIC:google.maps.UnitSystem.IMPERIAL};origin&&destination&&travelMode&&(this.$el.find("#directions_waiting").removeClass("hide"),this.directionsService.route(request,function(result,status){self.$el.find("#directions_waiting").addClass("hide"),result&&status===google.maps.DirectionsStatus.OK?(self.$("#routes").empty(),self.alert.set({wrnNoRoutesFound:!1,errDirectionService:!1}),self.collection.addRoutes(result)):status===google.maps.DirectionsStatus.ZERO_RESULTS?self.alert.set({wrnNoRoutesFound:!0}):status===google.maps.DirectionsStatus.NOT_FOUND||status===google.maps.DirectionsStatus.INVALID_REQUEST?(geocoder=new google.maps.Geocoder,geocoder.geocode({address:origin.toString()},function(results,status){status===google.maps.GeocoderStatus.OK?self.alert.set({wrnBadAddressDest:!0}):self.alert.set({wrnBadAddressOrigin:!0})})):self.alert.set({errDirectionService:!0})}),vent.trigger("trackEvent",{action:"Directions Panel",label:"Get Directions with Travel Mode: "+travelMode}))},changeMode:function(){var selectedMode="";""!==this.$origin.val()&&""!==this.$destination.val()&&(selectedMode=this.$("[name=travelMode]:checked").val(),this.currentMode=google.maps.TravelMode[selectedMode],this.submitSearch())},setDestination:function(){var address="",selected=this.searchResults.getSelected();selected&&(address=selected.addressText,this.$destination.val(address),this.$("#routes").html(this.template(selected.attributes)))},setDirectionInputs:function(options){var origin=this.collection.uriOrigin||"",destination=this.collection.uriDestination||"",renderRoute=options&&options.renderRoute;destination.length&&this.$destination.val(destination),origin.length&&this.$origin.val(origin),destination.length&&origin.length&&(renderRoute&&this.request.set({mapInitialize:!1}),this.submitSearch())},swapOriginDestination:function(){var origin=this.$origin.val(),destination=this.$destination.val(),temp="";return temp=origin,origin=destination,destination=temp,this.$origin.val(origin),this.$destination.val(destination),this.alert.resetDirectionAlerts(),vent.trigger("trackEvent",{action:"Directions Panel",label:"Swap A and B"}),!1},renderRoute:function(){this.directionsDisplay=new google.maps.DirectionsRenderer({draggable:!0}),this.directionsDisplay.setMap(this.storeMap),this.directionsDisplay.setPanel(document.getElementById("routes")),this.directionsDisplay.setDirections(this.collection.serviceResult)},placeRoute:function(){this.clearRouteDisplay(),this.searchResults.deselect(),this.collection.length>0&&(this.updateUrl(),this.request.unset("uriLocation",{silent:!0}),this.request.unset("uriLatLng",{silent:!0}),this.renderRoute())},clearRouteDisplay:function(){this.directionsDisplay&&(this.directionsDisplay.setMap(null),this.directionsDisplay.setPanel(null),this.request.set({urlDirectionsRoute:""},{silent:!0})),this.directionsDisplay=null},clearRouteOnIdleActive:function(){this.mapData.get("idleHandlerActive")&&(this.clearRouteDisplay(),this.collection.clearRoutes(),this.mapData.resetMapResults())},showDirectionsInfoWindow:function(){return this.navigation.get("isSmallScreen")&&this.navigation.selectDirection(),!1},updateUrl:function(){var origin=this.$origin.val(),destination=this.$destination.val(),urlRoute=[];origin.length>0&&destination.length>0&&(urlRoute.push("/from"),urlRoute.push(encodeURIComponent(origin)),urlRoute.push("to"),urlRoute.push(encodeURIComponent(destination)),this.request.set({urlDirectionsRoute:urlRoute.join("/")}))}});return DirectionsView}(jQuery,sb.storeloc.configData,sb.storeloc.eventTracker),sb.namespace("storeloc.StoresView"),sb.storeloc.RequestView=function(configData,vent){"use strict";var RequestView=Backbone.View.extend({initialize:function(options){this.features=options.features,this.mapData=options.mapData,this.searchResults=options.results,this.navigation=options.navigation,this.storeMap=options.map,this.alert=options.alert,this.userPermission=!1,this.listenTo(this.model,"resultsRequestedByLocation",this.requestStoresByLocation),this.listenTo(this.model,"resultRequestedById",this.requestStoreById),this.listenTo(this.model,"requestDetailPanel",this.requestDetailPanel),this.listenTo(this.features,"change:selected",this.featureChanged),this.listenTo(this.mapData,"change:center",this.requestStoresOnIdle),this.listenTo(this.mapData,"change:idleHandlerActive",this.requestGeolocation),this.listenTo(this.searchResults,"reset",this.resetSearchResults),this.listenTo(this.searchResults,"change:features",this.localizeFeatures),this.listenTo(this.searchResults,"add",this.addSearchResult),this.listenTo(this.searchResults,"remove",this.removeSearchResult),this.listenTo(this.searchResults,"change:successFetchingStores",this.toggleStoreWarningMessages),this.listenTo(this.searchResults,"change:errorFetchingStores",this.toggleStoreErrorMessages),this.listenTo(this.searchResults,"noInitialResultsForUser",this.promptUserForNearest),this.listenTo(this.searchResults,"change:showDetail",this.updateDetailUrl),this.listenTo(this.searchResults,"fetchedStoreByID",this.requestLocationByCoordinates),this.listenTo(this.navigation,"closeDetail",this.updateUrl),this.mapData.zoomedTooFarAway()||this.requestStoresOnInit()},toggleStoreWarningMessages:function(){var storeLength=this.searchResults.length,requestType=this.model.get("requestType"),featuresSelected=this.model.get("featuresSelected"),showNoStoresMatchingFilters=0===storeLength&&featuresSelected&&("search"===requestType||"geolocation"===requestType),showNoStoreWarning=!showNoStoresMatchingFilters&&0===storeLength&&("search"===requestType||"geolocation"===requestType);this.alert.set("errOpenAPI",!1),this.alert.set("wrnNoStoresReturned",showNoStoreWarning)},toggleStoreErrorMessages:function(){this.alert.set("errOpenAPI",!0)},featureChanged:function(){var center=this.model.get("location"),userLocated=this.model.get("userLocated");center?(this.model.set({requestType:userLocated?"geolocation":"search"}),this.requestStoresByLocation({location:center,userLocated:userLocated})):this.requestStoresOnIdle(!0)},requestStoresByLocation:function(options){var center=options.location,requestOptions={};center&&center.lat&&center.lng&&(this.searchResults.moreResults=!0,this.searchResults.nearestStore=!0,requestOptions.nearestStore=!0,requestOptions.allowRemoveAllStores=!1,requestOptions.center=center,requestOptions.init=!1,requestOptions.id=options.id,requestOptions.userLocated=options.userLocated,this.searchResults.clearResults(),this.mapData.setCenter(center,!0),this.mapData.set({idleHandlerActive:!0}),this.requestStoresByCenter(requestOptions))},requestStoresByCenter:function(options){var requestOptions={};options.center&&options.center.lat&&options.center.lng&&(requestOptions.latitude=options.center.lat(),requestOptions.longitude=options.center.lng(),requestOptions.brands=this.model.get("uriBrandCodes"),requestOptions.features=this.getSelectedFeatures(),requestOptions.userLocated=options.userLocated||this.model.get("userLocated"),requestOptions.init=options.init||!1,requestOptions.allowRemoveAllStores=options.allowRemoveAllStores||!1,requestOptions.id=options.id,this.searchResults.getNearbyLocations(requestOptions))},requestStoresOnIdle:function(allowRemoveAllStores){var center=this.mapData.get("center");this.model.set({requestType:"mapIdle"}),this.requestStoresByCenter({center:center,allowRemoveAllStores:allowRemoveAllStores,init:!1})},requestGeolocation:function(){this.mapData.get("idleHandlerActive")&&0===this.searchResults.length&&this.model.requestGeolocation()},requestStoresOnInit:function(){var center=this.mapData.get("center");this.model.set({requestType:"init",defaultInitializing:!0}),this.requestStoresByCenter({center:center,allowRemoveAllStores:!1,init:!0})},requestStoreById:function(options){options&&options.id&&this.searchResults.getLocationById(options.id)},requestLocationByCoordinates:function(options){options.coordinates&&this.model.setUriLatLngDetailOnly({id:options.id,lat:options.coordinates.latitude,lng:options.coordinates.longitude})},getSelectedFeatures:function(){var selectedFeatures=[];return selectedFeatures=this.features.filter(function(feature){return feature.has("selected")}),this.model.set({featuresSelected:selectedFeatures.length>0}),selectedFeatures},promptUserForNearest:function(options){var prompt=this.model.get("featuresSelected")?configData.storeLocatorUserPromptWithFilter:configData.storeLocatorUserPrompt;this.userPermission||(vent.trigger("trackEvent",{action:"Prompt For Nearest",label:"Prompt"}),this.userPermission=confirm(prompt),vent.trigger("trackEvent",{
action:"Prompt For Nearest",label:this.userPermission?"OK":"Cancel"})),this.userPermission?this.searchResults.getNearestLocation(options):(this.searchResults.moreResults=!this.mapData.zoomedTooFarAway(),this.searchResults.nearestStore=!1,this.mapData.set({fitBounds:!1}))},localizeFeatureNames:function(stores){var self=this;_(stores).each(function(store){self.localizeFeatureName(store.get("features"))})},localizeFeatureName:function(features){var self=this;features=features||[],_(features).each(function(feature){var model=_(self.features.models).find(function(model){return model.get("code")===feature.code});feature.localized=model&&model.get("name")?model.get("name"):feature.name})},resetSearchResults:function(){var models=this.searchResults.models,requestType=this.model.get("requestType"),id=this.searchResults.requestedId,uriLatLng=this.model.get("uriLatLng");this.model.get("defaultInitializing")&&this.model.set({defaultInitializing:!1}),this.localizeFeatureNames(models),id||"search"!==requestType&&"geolocation"!==requestType||this.updateUrl({updateUrl:!0}),id&&this.requestDetailPanel({id:id}),uriLatLng&&this.model.unset("uriLatLng",{silent:!0}),this.searchResults.trigger("change:resetSearchResults")},requestDetailPanel:function(options){var openDrawer=this.model.get("openDrawer");options&&options.id&&this.searchResults.showDetailPanel({id:options.id,openDrawer:openDrawer})},addSearchResult:function(result){this.localizeFeatureName(result.get("features")),result.set("added",!0)},removeSearchResult:function(result){result&&result.has("selected")&&this.searchResults.deselect()},localizeFeatures:function(result){this.localizeFeatureName(result.get("features"))},updateUrl:function(options){var requestType=this.model.get("requestType"),location="",latLng="",urlRoute=[],features=[];options&&options.updateUrl&&(this.model.set({useLocationUrl:!1}),"search"===requestType?(location=this.model.get("locationString"),latLng=this.model.get("latLngString"),location&&location.length?(this.model.set({useLocationUrl:!0}),urlRoute.push("/location"),urlRoute.push(encodeURIComponent(location))):latLng&&latLng.length&&(this.model.set({useLocationUrl:!0}),urlRoute.push("/latlng"),urlRoute.push(latLng))):"geolocation"===requestType&&urlRoute.push("/geolocate"),urlRoute.length&&this.model.get("featuresSelected")&&(urlRoute.push("features"),features=_.map(this.getSelectedFeatures(),function(feature){return feature.get("code")}),urlRoute.push(features.join(","))),this.model.set({urlRoute:urlRoute.join("/")}))},updateDetailUrl:function(options){var useLocationUrl=this.model.get("useLocationUrl"),location="",latLng="",urlRoute=[],features=[];options&&options.id&&(location=this.model.get("locationString"),latLng=this.model.get("latLngString"),(location&&location.length||latLng&&latLng.length)&&(useLocationUrl=!0),useLocationUrl?(location&&location.length?(urlRoute.push("/location"),urlRoute.push(encodeURIComponent(location))):latLng&&latLng.length&&(urlRoute.push("/latlng"),urlRoute.push(latLng)),urlRoute.push("detail"),urlRoute.push(options.id),urlRoute.length&&this.model.get("featuresSelected")&&(urlRoute.push("features"),features=_.map(this.getSelectedFeatures(),function(feature){return feature.get("code")}),urlRoute.push(features.join(","))),this.model.set({useLocationUrl:!1})):(urlRoute.push("/detail"),urlRoute.push(options.id))),this.model.set({urlRoute:urlRoute.join("/")})}});return RequestView}(sb.storeloc.configData,sb.storeloc.eventTracker),sb.namespace("storeloc.NavView"),sb.storeloc.NavView=function($,vent){"use strict";var NavView=Backbone.View.extend({el:"#store-locator-nav-wrap",events:{"click #search_stores_nav":"evClickSearchDrawer","click #directions_nav":"evClickDirectionsDrawer","click #m_map":"viewMap","click #m_logo":"evClickLogo","click #m_signin":"evClickSignIn","click #m_nav a":"evClickMegaMenu"},initialize:function(options){this.$map=$("#map_canvas"),this.$storeLocNavLinks=$(this.el).find("#store-locator-nav a"),this.$drawer=$("#drawer"),this.selected_class="selected",this.android_fix_bug67179="android_b67179",this.android_fix_bug74972="android_b74972",this.mapData=options.mapData,this.alert=options.alert,this.drawerMap={search:{content:"#search-stores",link:"#search_stores_nav"},directions:{content:"#directions",link:"#directions_nav"},map:"#m_map"},this.navLinkMap={search_stores_nav:"search",directions_nav:"directions"},this.listenTo(this.model,"change:selectedDrawer",this.navOpen),this.listenTo(this.model,"change:resultSelected",this.navClose),this.listenTo(this.model,"change:routeSelected",this.navClose),this.listenTo(this.model,"change:isSmallScreen",this.setNavLayout),this.listenTo(this.model,"change:selectedNav",this.setSelectedNav),this.listenTo(this.model,"showMap",this.viewMap),this.listenTo(this.model,"hideDrawer",this.hideDrawer),sb.rwd.onDelayedResize($.proxy(this.checkViewport,this),!0)},evClickLogo:function(){vent.trigger("trackEvent",{action:"Navigation",label:"Logo"})},evClickMegaMenu:function(e){var elm=e&&e.currentTarget?$(e.currentTarget).find("strong"):null,section=elm?elm.html():"";vent.trigger("trackEvent",{action:"Navigation",label:"MegaMenu - "+section})},evClickSignIn:function(){vent.trigger("trackEvent",{action:"Navigation",label:"SignIn"})},evClickSearchDrawer:function(e){return this.selectDrawer(e),vent.trigger("trackEvent",{action:"Navigation",label:"Store"}),!1},evClickDirectionsDrawer:function(e){return this.selectDrawer(e),vent.trigger("trackEvent",{action:"Navigation",label:"Directions"}),!1},selectDrawer:function(e){var id=e.currentTarget.id,navSelection=this.navLinkMap[id];return this.navSelect(navSelection),!1},navOpen:function(){var selected=this.model.get("selectedDrawer"),open=this.model.get("openDrawer");this.applyAndroidFix(selected),open?open!==selected&&(this.hideContent(),this.model.openDrawer(selected),this.showContent()):(this.model.openDrawer(selected),this.showContent(),this.openDrawerUI()),this.model.selectNav(selected),this.model.resetSelected()},navClose:function(){this.model.selectNav("map"),this.closeDrawerUI(),this.hideContent(),this.model.unset("openDrawer")},openDrawerUI:function(){this.$map.addClass("drawerOpen"),this.$drawer.addClass("drawerOpen"),this.mapData.set({drawer:"open"})},closeDrawerUI:function(){this.$map.removeClass("drawerOpen"),this.$drawer.removeClass("drawerOpen"),this.mapData.set({drawer:"closed"})},showContent:function(){var selected=this.model.get("openDrawer");this.$drawer.hasClass(this.android_fix_bug67179)&&"directions"===selected&&$(this.drawerMap.search.content).show(),$(this.drawerMap[selected].content).fadeIn("fast")},hideContent:function(){var selected=this.model.get("openDrawer");this.$drawer.hasClass(this.android_fix_bug67179)&&"search"===selected||$(this.drawerMap[selected].content).fadeOut("fast")},hideDrawer:function(options){options&&options.drawer&&(this.model.set({openDrawer:options.drawer}),this.hideContent(),this.model.unset("openDrawer"))},navSelect:function(drawer){var open=this.model.get("openDrawer"),otherDrawer="search"===drawer?"directions":"search";this.applyAndroidFix(drawer),open===drawer?(this.model.selectMapNav(),this.closeDrawerUI(),this.hideContent(),this.model.set({prevDrawer:drawer}),this.model.unset("openDrawer")):open===otherDrawer?(this.model.selectNav(drawer),this.hideContent(),this.model.openDrawer(drawer),this.showContent()):(this.hideDrawer({drawer:otherDrawer}),this.model.selectNav(drawer),this.model.openDrawer(drawer),this.showContent(),this.openDrawerUI()),"search"===drawer?(this.alert.resetDirectionAlerts(),this.setIdleHandlerActive(),this.model.showSearchResults()):"directions"===drawer&&this.alert.resetSearchAlerts()},viewMap:function(){var prev=this.model.get("prevDrawer"),open=this.model.get("openDrawer");return prev?open?(this.closeDrawerUI(),this.hideContent(),this.model.selectMapNav(),this.model.unset("openDrawer")):(this.model.selectNav(prev),this.model.set({openDrawer:prev}),this.showContent(),this.openDrawerUI()):this.model.selectMapNav(),vent.trigger("trackEvent",{action:"Navigation",label:(open?"Close":"Open")+" Drawer"}),!1},setSelectedNav:function(){var selected=this.model.get("selectedNav"),link="map"===selected?this.drawerMap[selected]:this.drawerMap[selected].link;this.$storeLocNavLinks.removeClass(this.selected_class),$(link).addClass(this.selected_class)},checkViewport:function(){sb.rwd.matchViewport("M")?this.model.set({isSmallScreen:!1}):this.model.set({isSmallScreen:!0})},setNavLayout:function(){var $logo=$("#logo"),$nav=$("#nav"),$signinLink=$("#signIn"),$utilityDash=$(".utility_dash"),$current=$("a.current"),$header=$("#header"),$headerSkip=$header.find(".skip");this.model.get("isSmallScreen")?($logo.appendTo("#m_logo"),$signinLink.length>0?$signinLink.appendTo("#m_signin"):$utilityDash.length>0&&$("a.current").appendTo("#m_signin"),$nav.appendTo("#m_nav")):($headerSkip.after($logo),$header.append($nav),$signinLink.length>0?$signinLink.appendTo(".signin"):$utilityDash.length>0&&$utilityDash.append($current))},setIdleHandlerActive:function(){this.mapData.set({idleHandlerActive:!0})},applyAndroidFix:function(drawer){this.$drawer.removeClass(this.android_fix_bug67179),this.$drawer.removeClass(this.android_fix_bug74972),this.model.get("isSmallScreen")&&("directions"===drawer?this.$drawer.addClass(this.android_fix_bug67179):"search"===drawer&&this.$drawer.addClass(this.android_fix_bug74972))}});return NavView}(jQuery,sb.storeloc.eventTracker),sb.namespace("storeloc.AlertView"),sb.storeloc.AlertView=function($,vent){"use strict";var AlertView=Backbone.View.extend({el:"#alert-messages",events:{click:"closeAlertMessage"},initialize:function(){this.listenTo(this.model,"change:errMapService",this.toggleErrorMessages),this.listenTo(this.model,"change:errLocationService",this.toggleErrorMessages),this.listenTo(this.model,"change:errDirectionService",this.toggleErrorMessages),this.listenTo(this.model,"change:errOpenAPI",this.toggleErrorMessages),this.listenTo(this.model,"change:errBrowserAutoGeo",this.toggleErrorMessages),this.listenTo(this.model,"change:wrnNoStoresReturned",this.toggleWarningMessages),this.listenTo(this.model,"change:wrnAllStoresFiltered",this.toggleWarningMessages),this.listenTo(this.model,"change:wrnUserPermissionAutoGeo",this.toggleWarningMessages),this.listenTo(this.model,"change:wrnBadAddressSearch",this.toggleSearchAddressMessage),this.listenTo(this.model,"change:wrnNoRoutesFound",this.toggleDirectionAddressMessage),this.listenTo(this.model,"change:wrnBadAddressOrigin",this.toggleDirectionAddressMessage),this.listenTo(this.model,"change:wrnBadAddressDest",this.toggleDirectionAddressMessage)},toggleErrorMessages:function(){var errMapService=this.model.get("errMapService"),errLocationService=this.model.get("errLocationService"),errDirectionService=this.model.get("errDirectionService"),errOpenAPI=this.model.get("errOpenAPI"),errBrowserAutoGeo=this.model.get("errBrowserAutoGeo"),errShow=errMapService||errLocationService||errDirectionService||errOpenAPI||errBrowserAutoGeo;$("#errMapService").toggle(errMapService),$("#errLocationService").toggle(errLocationService),$("#errDirectionService").toggle(errDirectionService),$("#errOpenAPI").toggle(errOpenAPI),$("#errBrowserAutoGeo").toggle(errBrowserAutoGeo),this.$el.find(".error").toggle(errShow),this.$el.toggle(errShow),errMapService&&vent.trigger("trackEvent",{action:"Message",label:"errMapService"}),errLocationService&&vent.trigger("trackEvent",{action:"Message",label:"errLocationService"}),errDirectionService&&vent.trigger("trackEvent",{action:"Message",label:"errDirectionService"}),errOpenAPI&&vent.trigger("trackEvent",{action:"Message",label:"errOpenAPI"}),errBrowserAutoGeo&&vent.trigger("trackEvent",{action:"Message",label:"errBrowserAutoGeo"})},toggleWarningMessages:function(){var wrnNoStoresReturned=this.model.get("wrnNoStoresReturned"),wrnAllStoresFiltered=this.model.get("wrnAllStoresFiltered"),wrnShow=wrnNoStoresReturned||wrnAllStoresFiltered;$("#wrnNoStoresReturned").toggle(wrnNoStoresReturned),$("#wrnAllStoresFiltered").toggle(wrnAllStoresFiltered),this.$el.find(".warning").toggle(wrnShow),this.$el.toggle(wrnShow),wrnNoStoresReturned&&vent.trigger("trackEvent",{action:"Message",label:"wrnNoStoresReturned"}),wrnAllStoresFiltered&&vent.trigger("trackEvent",{action:"Message",label:"wrnAllStoresFiltered"})},toggleSearchAddressMessage:function(){var wrnBadAddressSearch=this.model.get("wrnBadAddressSearch");$("#searchForm li.searchField").toggleClass("error",wrnBadAddressSearch),wrnBadAddressSearch&&vent.trigger("trackEvent",{action:"Message",label:"wrnBadAddressSearch"})},toggleDirectionAddressMessage:function(){var wrnBadAddressOrigin=this.model.get("wrnBadAddressOrigin"),wrnBadAddressDest=this.model.get("wrnBadAddressDest"),wrnNoRoutesFound=this.model.get("wrnNoRoutesFound");$("#directionsForm li.origin").toggleClass("error",wrnBadAddressOrigin),$("#directionsForm li.destination").toggleClass("error",wrnBadAddressDest),$("#directionsForm li.noRoute").toggle(wrnNoRoutesFound),wrnBadAddressOrigin&&vent.trigger("trackEvent",{action:"Message",label:"wrnBadAddressOrigin"}),wrnBadAddressDest&&vent.trigger("trackEvent",{action:"Message",label:"wrnBadAddressDest"}),wrnNoRoutesFound&&vent.trigger("trackEvent",{action:"Message",label:"wrnNoRoutesFound"})},closeAlertMessage:function(){return this.$el.hide(),this.model.resetWarningAlerts(),vent.trigger("trackEvent",{action:"Message",label:"Close Message"}),!1}});return AlertView}(jQuery,sb.storeloc.eventTracker),sb.namespace("storeloc.WaitingView"),sb.storeloc.WaitingView=function(configData){"use strict";var WaitingView=Backbone.View.extend({el:"#fetch_waiting",initialize:function(options){this.request=options.request,this.waitHandle=null,this.OAuthTimeoutHandle=null,this.listenTo(this.collection,"change:doneFetchingStores",this.doneFetchingStores),this.listenTo(this.collection,"change:startFetchingStores",this.startFetchingStores)},startFetchingStores:function(){var self=this,requestType=this.request.get("requestType");"mapIdle"!==requestType&&(this.waitHandle&&(clearTimeout(this.waitHandle),delete this.waitHandle),this.waitHandle=setTimeout(function(){self.$el.removeClass("hide")},300),this.OAuthTimeoutHandle=setTimeout(function(){self.doneFetchingStores(),self.collection.refreshToken()},6e4*configData.storeLocatorOpenApiRequestTimeout))},doneFetchingStores:function(){clearTimeout(this.waitHandle),clearTimeout(this.OAuthTimeoutHandle),delete this.waitHandle,delete this.OAuthTimeoutHandle,this.$el.addClass("hide")}});return WaitingView}(sb.storeloc.configData),sb.namespace("storeloc.AppRouter"),sb.storeloc.AppRouter=function(configData,Navigation,Alert,Features,FeaturesView,Request,SearchResults,UserLocation,MapData,UserLocationView,SearchView,SearchResultsView,Routes,MapView,DirectionsView,RequestView,NavView,AlertView,WaitingView){"use strict";var AppRouter=Backbone.Router.extend({routes:{"":"defaultRoute","search/latlng/:latlng/detail/:detailID(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"latLngSearchAndDetail","search/latlng/:latlng(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"latLngSearch","search/location/:location/detail/:detail(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"locationSearchAndDetail","search/location/:location(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"locationSearch","search/geolocate(/features/:features)(/*path)":"geolocateSearch","search/detail/:detailID(/zoom/:zoom)(/*path)":"searchDetail","search/*path":"defaultRoute",search:"defaultRoute","directions/latlng/:latlng/detail/:detailID(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"latLngDirectionsAndDetail","directions/latlng/:latlng(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"latLngDirections","directions/location/:location/detail/:detail(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"locationDirectionsAndDetail","directions/location/:location(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"locationDirections","directions/geolocate(/features/:features)(/*path)":"geolocateDirections","directions/detail/:detailID(/zoom/:zoom)(/*path)":"directionsDetail","directions/to/:to(/from/:from)(/*path)":"directionsToFrom","directions/from/:from(/to/:to)(/*path)":"directionsFromTo","directions/*path":"directionsDefault",directions:"directionsDefault","map/latlng/:latlng/detail/:detailID(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"latLngMapAndDetail","map/location/:location/detail/:detailID(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"locationMapAndDetail","map/latlng/:latlng(/zoom/:zoom)(/brands/:brands)(/features/:features)(/*path)":"latLngMap","map/location/:location(/zoom)(/:zoom)(/brands/:brands)(/features/:features)(/*path)":"locationMap","map/geolocate(/features/:features)(/*path)":"geolocateMap","map/to/:to(/from/:from)(/*path)":"mapToFrom","map/from/:from(/to/:to)(/*path)":"mapFromTo","map/detail/:detailID(/zoom/:zoom)(/*path)":"mapDetail","map/*path":"mapDefault",map:"mapDefault","*path":"defaultRoute"},defaultRoute:function(){this.requestedRoute=this.getCurrentRoute(),this.mapData.initialZoomIsBelowThreshold()&&this.request.requestGeolocation(),this.navigation.hideDirectionsDrawerContent(),this.navigation.selectSearchDrawer(!0),this.searchResults.closeDetail()},latLngRoutes:function(options){var latLngArray=this.request.latLngStrToArray(options.latlng),requestOptions={};2===latLngArray.length&&(options.zoom&&this.mapData.setUriZoom(options.zoom),requestOptions.lat=latLngArray[0],requestOptions.lng=latLngArray[1],this.request.isValidId(options.id)&&(requestOptions.id=options.id),this.request.setUriLatLng(requestOptions)),options.features&&this.request.setUriFeatures(options.features),options.brands&&this.request.setUriBrandCodes(options.brands)},locationRoutes:function(options){var requestOptions={};this.request.isValidUriLocation(options.location)&&(options.zoom&&this.mapData.setUriZoom(options.zoom),requestOptions.location=options.location,this.request.isValidId(options.id)&&(requestOptions.id=options.id),this.request.setUriLocation(requestOptions)),options.features&&this.request.setUriFeatures(options.features),options.brands&&this.request.setUriBrandCodes(options.brands)},geolocateRoutes:function(features){this.request.setUriFeatures(features),this.request.requestGeolocation()},latLngSearchAndDetail:function(latlng,detailID,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.request.set({openDrawer:!0}),this.latLngRoutes({latlng:latlng,zoom:zoom,brands:brands,features:features,id:detailID}),this.navigation.hideDirectionsDrawerContent(),this.navigation.selectSearchDrawer(!1)},latLngSearch:function(latlng,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.searchResults.closeDetail(),this.latLngRoutes({latlng:latlng,zoom:zoom,brands:brands,features:features}),this.navigation.hideDirectionsDrawerContent(),this.navigation.selectSearchDrawer(!1)},locationSearchAndDetail:function(location,detailID,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.request.set({openDrawer:!0}),this.locationRoutes({location:location,zoom:zoom,brands:brands,features:features,id:detailID}),this.navigation.hideDirectionsDrawerContent(),this.navigation.selectSearchDrawer(!1)},locationSearch:function(location,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.searchResults.closeDetail(),this.locationRoutes({location:location,zoom:zoom,brands:brands,features:features}),this.navigation.hideDirectionsDrawerContent(),this.navigation.selectSearchDrawer(!1)},geolocateSearch:function(features){this.requestedRoute=this.getCurrentRoute(),this.geolocationIsAllowed()&&(this.geolocateRoutes(features),this.navigation.locateUser()),this.navigation.hideDirectionsDrawerContent(),this.navigation.selectSearchDrawer(!0)},searchDetail:function(detailID){this.requestedRoute=this.getCurrentRoute(),this.searchResults.get(detailID)?this.searchResults.showDetailPanel({id:detailID,openDrawer:!0}):this.request.requestLocationById({id:detailID,openDrawer:!0})},directionsDefault:function(){this.requestedRoute=this.getCurrentRoute(),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(!0),this.request.requestGeolocation()},latLngDirectionsAndDetail:function(latlng,detailID,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.request.set({openDrawer:!1}),this.latLngRoutes({latlng:latlng,zoom:zoom,brands:brands,features:features,id:detailID}),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(!1)},latLngDirections:function(latlng,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.latLngRoutes({latlng:latlng,zoom:zoom,brands:brands,features:features}),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(!1)},locationDirectionsAndDetail:function(location,detailID,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.request.set({openDrawer:!1}),this.locationRoutes({location:location,zoom:zoom,brands:brands,features:features,id:detailID}),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(!1)},locationDirections:function(location,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.locationRoutes({location:location,zoom:zoom,brands:brands,features:features}),this.navigation.hideSearchDrawerContent(),this.searchResults.closeDetail(),this.navigation.selectDirectionsDrawer(!1)},geolocateDirections:function(features){this.requestedRoute=this.getCurrentRoute(),this.geolocationIsAllowed()&&(this.geolocateRoutes(features),this.navigation.locateUser()),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(!0)},directionsDetail:function(detailID){this.requestedRoute=this.getCurrentRoute(),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(),this.searchResults.get(detailID)?this.searchResults.showDetailPanel({id:detailID,openDrawer:!1}):this.request.requestLocationById({id:detailID,openDrawer:!1})},directionsToFrom:function(to,from){this.requestedRoute=this.getCurrentRoute(),this.routes.setUriDirectionInputs({to:this.request.trimAndDecode(to),from:this.request.trimAndDecode(from)}),this.navigation.hideSearchDrawerContent(),this.navigation.selectDirectionsDrawer(!1)},directionsFromTo:function(from,to){this.directionsToFrom(to,from)},mapDefault:function(){this.requestedRoute=this.getCurrentRoute(),this.navigation.showMap(!0),this.request.requestGeolocation()},latLngMapAndDetail:function(latlng,detailID,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.request.set({openDrawer:!1}),this.latLngRoutes({latlng:latlng,zoom:zoom,brands:brands,features:features,id:detailID}),this.navigation.hideDirectionsDrawerContent(),this.navigation.showMap(!1)},locationMapAndDetail:function(location,detailID,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.request.set({openDrawer:!1}),this.locationRoutes({location:location,zoom:zoom,brands:brands,features:features,id:detailID}),this.navigation.hideDirectionsDrawerContent(),this.navigation.showMap(!0)},latLngMap:function(latlng,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.latLngRoutes({latlng:latlng,zoom:zoom,brands:brands,features:features}),this.navigation.showMap(!1)},locationMap:function(location,zoom,brands,features){this.requestedRoute=this.getCurrentRoute(),this.locationRoutes({location:location,zoom:zoom,brands:brands,features:features}),this.navigation.showMap(!1)},geolocateMap:function(features){this.requestedRoute=this.getCurrentRoute(),this.geolocationIsAllowed()&&(this.geolocateRoutes(features),this.navigation.locateUser()),this.navigation.showMap(!0)},mapDetail:function(detailID){this.requestedRoute=this.getCurrentRoute(),this.navigation.showMap(!0),this.searchResults.get(detailID)?this.searchResults.showDetailPanel({id:detailID,openDrawer:!1}):this.request.requestLocationById({id:detailID,openDrawer:!1})},mapToFrom:function(to,from){this.requestedRoute=this.getCurrentRoute(),this.routes.setUriDirectionInputs({to:to,from:from}),this.navigation.showMap(!1)},mapFromTo:function(from,to){this.mapToFrom(to,from)},initialize:function(){var searchOptions={url:configData.storeLocatorAPIUrl,radius:configData.storeLocatorIsMetric?Math.round(Globalize.convert.kmToMiles(configData.storeLocatorRadius)):configData.storeLocatorRadius,limit:configData.storeLocatorLimit,defaultBrandCode:configData.storeLocatorDefaultBrand,apikeyParam:configData.storeLocatorAPIParam,daysOfWeek:configData.daysOfWeek,holidays:configData.holidays};this.requestedRoute="",this.historyEntries=[],this.mapData=new MapData({configData:configData}),this.storeMap=new google.maps.Map(document.getElementById("map_canvas"),this.mapData.getMapOptions()),this.searchResults=new SearchResults(null,searchOptions),this.alert=new Alert,this.navigation=new Navigation,this.request=new Request,this.userLocation=new UserLocation,this.routes=new Routes,this.features=new Features(configData.storeLocatorFeatures),this.searchResultsView=new SearchResultsView({collection:this.searchResults,navigation:this.navigation,userLocation:this.userLocation,request:this.request}),this.mapView=new MapView({map:this.storeMap,navigation:this.navigation,mapData:this.mapData,request:this.request,results:this.searchResults,routes:this.routes,userLocation:this.userLocation}),this.searchView=new SearchView({collection:this.searchResults,navigation:this.navigation,map:this.storeMap,request:this.request,alert:this.alert}),this.directionsView=new DirectionsView({collection:this.routes,navigation:this.navigation,map:this.storeMap,mapData:this.mapData,userLocation:this.userLocation,results:this.searchResults,request:this.request,alert:this.alert}),this.featuresView=new FeaturesView({collection:this.features,results:this.searchResults,navigation:this.navigation,request:this.request}),this.requestView=new RequestView({model:this.request,features:this.features,results:this.searchResults,navigation:this.navigation,mapData:this.mapData,alert:this.alert}),this.navView=new NavView({model:this.navigation,mapData:this.mapData,results:this.searchResults,alert:this.alert}),this.locationView=new UserLocationView({collection:this.searchResults,model:this.userLocation,navigation:this.navigation,map:this.storeMap,request:this.request,alert:this.alert,mapData:this.mapData}),this.alertView=new AlertView({model:this.alert}),this.waitingView=new WaitingView({collection:this.searchResults,request:this.request}),this.listenTo(this.navigation,"change:selectedNav",this.navigateSelected),this.listenTo(this.request,"change:urlRoute",this.navigateSelected),this.listenTo(this.request,"change:urlDirectionsRoute",this.navigateSelected),this.listenTo(this.request,"change:reloadRoute",this.navigateAndReload)},geolocationIsAllowed:function(){var initializing=this.request.get("defaultInitializing");return!initializing||this.mapData.initialZoomIsBelowThreshold()},navigateSelected:function(){var selected=this.navigation.get("selectedNav"),urlRoute=this.request.get("urlRoute")||"",urlDirectionsRoute=this.request.get("urlDirectionsRoute")||"",update=this.navigation.get("updateUrl"),route="";selected&&update&&(route="search"===selected.toLowerCase()?selected+urlRoute:selected+(urlDirectionsRoute.length>0?urlDirectionsRoute:urlRoute),this.requestedRoute!==decodeURIComponent(route)&&(this.requestedRoute="",this.historyEntries.push(route),this.navigate(route))),this.navigation.set({updateUrl:!0})},navigateAndReload:function(){var selected=this.navigation.get("selectedNav"),reloadRoute=this.request.get("reloadRoute");this.navigate(selected+reloadRoute),location.reload()},getCurrentRoute:function(){var path=location.pathname,regex=new RegExp("^\\/"+path.split("/")[1]+"\\/","i"),route=path.replace(regex,"");return route}});return AppRouter}(sb.storeloc.configData,sb.storeloc.Navigation,sb.storeloc.Alert,sb.storeloc.Features,sb.storeloc.FeaturesView,sb.storeloc.Request,sb.storeloc.SearchResults,sb.storeloc.UserLocation,sb.storeloc.MapData,sb.storeloc.UserLocationView,sb.storeloc.SearchView,sb.storeloc.SearchResultsView,sb.storeloc.Routes,sb.storeloc.MapView,sb.storeloc.DirectionsView,sb.storeloc.RequestView,sb.storeloc.NavView,sb.storeloc.AlertView,sb.storeloc.WaitingView),_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g},sb.namespace("storeloc"),$(function(){"use strict";var hasPushState=!(!window.history||!window.history.pushState),path=document.location.pathname,root=path.split("/")[1],pattern="^\\/"+root+"\\/.+",regex=new RegExp(pattern,"i"),route="";!hasPushState&&regex.exec(path)?(route=path.replace(/(\/[^\/]*)(\/)/,"$1#"),location.replace(route)):$.ajax({url:"/resources/apitkn",success:function(data,status,request){data&&$.trim(data)&&(sb.storeloc.configData.storeLocatorAPIParam="access_token="+data,sb.storeloc.oAuthTimestamp=(new Date).getTime(),sb.console.log("access_token="+data),sb.console.log("timestamp="+sb.storeloc.oAuthTimestamp),new sb.storeloc.AppRouter,Backbone.history.start({pushState:!0,root:root}))},error:function(){}})});